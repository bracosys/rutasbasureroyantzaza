{% extends "base.html" %}

{% block title %}Crear Usuario - Sistema de Optimización de Rutas{% endblock %}

{% block page_title %}Crear Nuevo Usuario{% endblock %}

{% block sidebar_items %}
<li class="nav-item">
    <a href="{{ url_for('admin_dashboard') }}" class="nav-link">
        <i class="fas fa-tachometer-alt me-2"></i> Dashboard
    </a>
</li>
<li class="nav-item">
    <a href="{{ url_for('manage_users') }}" class="nav-link active">
        <i class="fas fa-users me-2"></i> Usuarios
    </a>
</li>
<li class="nav-item">
    <a href="{{ url_for('manage_routes') }}" class="nav-link">
        <i class="fas fa-route me-2"></i> Rutas
    </a>
</li>
<li class="nav-item">
    <a href="{{ url_for('manage_vehicles') }}" class="nav-link">
        <i class="fas fa-truck me-2"></i> Vehículos
    </a>
</li>
{% endblock %}

{% block content %}
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Crear nuevo usuario</h6>
    </div>
    <div class="card-body">
        <form action="{{ url_for('create_user') }}" method="POST" id="createUserForm">
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="username" class="form-label">Nombre de usuario *</label>
                    <input type="text" class="form-control" id="username" name="username" required>
                </div>
                <div class="col-md-6">
                    <label for="email" class="form-label">Correo electrónico *</label>
                    <input type="email" class="form-control" id="email" name="email" required>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="password" class="form-label">Contraseña *</label>
                    <input type="password" class="form-control" id="password" name="password" required minlength="6">
                </div>
                <div class="col-md-6">
                    <label for="cedula" class="form-label">Cédula *</label>
                    <input type="text" class="form-control" id="cedula" name="cedula" required>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="first_name" class="form-label">Nombre *</label>
                    <input type="text" class="form-control" id="first_name" name="first_name" required>
                </div>
                <div class="col-md-6">
                    <label for="last_name" class="form-label">Apellido *</label>
                    <input type="text" class="form-control" id="last_name" name="last_name" required>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="role" class="form-label">Rol *</label>
                    <select class="form-select" id="role" name="role" required>
                        <option value="">Seleccionar rol</option>
                        <option value="admin">Administrador</option>
                        <option value="technician">Técnico</option>
                        <option value="coordinator">Coordinador</option>
                        <option value="driver">Chofer</option>
                    </select>
                    <div class="form-text">Selecciona el rol del usuario en el sistema.</div>
                </div>
                <div class="col-md-6" id="license_type_container" style="display: none;">
                    <label for="license_type" class="form-label">Tipo de licencia</label>
                    <select class="form-select" id="license_type" name="license_type">
                        <option value="">Seleccionar tipo de licencia</option>
                        <option value="A">Tipo A - Motocicletas</option>
                        <option value="B">Tipo B - Vehículos livianos</option>
                        <option value="C">Tipo C - Vehículos pesados</option>
                        <option value="D">Tipo D - Transporte público</option>
                        <option value="E">Tipo E - Articulados</option>
                        <option value="F">Tipo F - Especiales</option>
                        <option value="G">Tipo G - Maquinaria</option>
                    </select>
                    <div class="form-text">Requerido solo para choferes.</div>
                </div>
            </div>
            
            <!-- Información sobre los roles -->
            <div class="alert alert-info">
                <h6><i class="fas fa-info-circle me-2"></i>Descripción de roles:</h6>
                <ul class="mb-0">
                    <li><strong>Administrador:</strong> Acceso completo al sistema, puede gestionar usuarios, rutas y vehículos.</li>
                    <li><strong>Técnico:</strong> Puede cambiar contraseñas y ocultar/mostrar usuarios (excepto administradores).</li>
                    <li><strong>Coordinador:</strong> Solo puede ver métricas, mapas y revisar recorridos.</li>
                    <li><strong>Chofer:</strong> Puede ver rutas disponibles y realizar recorridos con navegación GPS.</li>
                </ul>
            </div>
            
            <div class="d-flex justify-content-between mt-4">
                <a href="{{ url_for('manage_users') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Crear Usuario
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Mostrar/ocultar campo de licencia según el rol seleccionado
        $('#role').on('change', function() {
            const selectedRole = $(this).val();
            const licenseContainer = $('#license_type_container');
            const licenseSelect = $('#license_type');
            
            if (selectedRole === 'driver') {
                licenseContainer.show();
                licenseSelect.attr('required', true);
            } else {
                licenseContainer.hide();
                licenseSelect.attr('required', false);
                licenseSelect.val('');
            }
        });
        
        // Validación adicional del formulario
        $('#createUserForm').on('submit', function(e) {
            const role = $('#role').val();
            const licenseType = $('#license_type').val();
            
            if (role === 'driver' && !licenseType) {
                e.preventDefault();
                alert('Debe seleccionar un tipo de licencia para los choferes.');
                $('#license_type').focus();
                return false;
            }
        });
    });
</script>
{% endblock %}