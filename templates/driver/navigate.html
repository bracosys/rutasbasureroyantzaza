{% extends "base.html" %}

{% block title %}Navegando: {{ route.name }} - Sistema de Optimización de Rutas{% endblock %}

{% block page_title %}Navegando: {{ route.name }}{% endblock %}

{% block meta_tags %}
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
{% endblock %}

{% block sidebar_items %}
<li class="nav-item">
    <a href="{{ url_for('driver_dashboard') }}" class="nav-link">
        <i class="fas fa-tachometer-alt me-2"></i> Dashboard
    </a>
</li>
<li class="nav-item">
    <a href="{{ url_for('driver_route_history') }}" class="nav-link">
        <i class="fas fa-history me-2"></i> Historial de rutas
    </a>
</li>
{% endblock %}

{% block content %}
<!-- Panel de instrucciones de navegación (fijo arriba en móvil) -->
<div id="navigationInstructions" class="fixed-top bg-primary text-white p-3 shadow d-block d-lg-none"
    style="top: 56px; z-index: 1040; display: none !important;">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-auto">
                <i id="instructionIcon" class="fas fa-arrow-up fa-2x"></i>
            </div>
            <div class="col">
                <div id="currentInstruction" class="fw-bold">Calculando ruta...</div>
                <small id="instructionDistance" class="text-light">Iniciando navegación</small>
            </div>
            <div class="col-auto">
                <button class="btn btn-sm btn-outline-light" onclick="toggleInstructionPanel()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Contenedor principal responsive -->
<div class="container-fluid px-2" style="margin-top: 0;">
    <div class="row">
        <!-- Panel de control - Móvil primero -->
        <div class="col-12 col-lg-4 mb-3 mb-lg-4">
            <!-- Card de información de ruta -->
            <div class="card shadow">
                <div class="card-header py-2 py-lg-3 bg-success text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-route me-2"></i>Ruta en Progreso
                    </h6>
                </div>
                <div class="card-body p-3">
                    <div class="mb-3">
                        <strong>Ruta:</strong>
                        <span class="d-block d-lg-inline">{{ route.name }}</span>
                    </div>

                    {% if route.distance %}
                    <div class="mb-3">
                        <strong>Distancia:</strong> {{ route.distance|distance_format }}
                    </div>
                    {% endif %}

                    <div class="mb-3">
                        <strong>Iniciada:</strong>
                        <span class="d-block d-lg-inline">{{ completion.started_at|datetime_format }}</span>
                    </div>

                    {% if completion.vehicle %}
                    <div class="mb-3">
                        <strong>Vehículo:</strong>
                        <span class="d-block">{{ completion.vehicle.brand }} {{ completion.vehicle.model }}</span>
                        <small class="text-muted">Placa: {{ completion.vehicle.plate_number }}</small>
                    </div>
                    {% endif %}

                    {% if completion.fuel_start %}
                    <div class="mb-3">
                        <strong>Combustible inicial:</strong>
                        <span class="badge bg-info">{{ completion.fuel_start }}/4</span>
                    </div>
                    {% endif %}

                    <!-- Estado de GPS con indicador visual mejorado -->
                    <div class="mb-3">
                        <strong>Estado GPS:</strong>
                        <span id="gpsStatus" class="badge bg-secondary">
                            <i class="fas fa-satellite-dish me-1"></i>Desconectado
                        </span>
                        <div id="gpsAccuracy" class="small text-muted mt-1" style="display: none;"></div>
                    </div>

                    <!-- Posición actual mejorada para móvil -->
                    <div class="mb-3" id="currentPosition" style="display: none;">
                        <strong>Posición actual:</strong>
                        <div id="coordinates" class="small text-muted mt-1"></div>
                        <div id="lastUpdate" class="small text-muted"></div>
                    </div>

                    <!-- Tiempo transcurrido -->
                    <div class="mb-3">
                        <strong>Tiempo transcurrido:</strong>
                        <span id="elapsedTime" class="badge bg-primary">00:00:00</span>
                    </div>

                    <!-- NUEVA SECCIÓN: Próxima instrucción (desktop) -->
                    <div class="mb-3 d-none d-lg-block" id="nextInstructionCard" style="display: none !important;">
                        <strong>Próxima instrucción:</strong>
                        <div class="alert alert-info p-2 mt-2 mb-0">
                            <div class="d-flex align-items-center">
                                <i id="nextInstructionIcon" class="fas fa-arrow-up fa-lg me-2"></i>
                                <div>
                                    <div id="nextInstructionText" class="fw-bold small">Continúa recto</div>
                                    <small id="nextInstructionDistance" class="text-muted">en 500m</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- NUEVA SECCIÓN: Progreso de ruta -->
                    <div class="mb-3" id="routeProgress" style="display: none;">
                        <strong>Progreso de ruta:</strong>
                        <div class="progress mt-2" style="height: 20px;">
                            <div id="progressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%;">
                                <span id="progressText" class="small fw-bold">0%</span>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mt-1">
                            <small class="text-muted">Restante: <span id="remainingDistance">-- km</span></small>
                            <small class="text-muted">ETA: <span id="estimatedArrival">--:--</span></small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controles de navegación optimizados para móvil -->
            <div class="card shadow mt-3">
                <div class="card-header py-2 py-lg-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-directions me-2"></i>Controles de Navegación
                    </h6>
                </div>
                <div class="card-body p-3">
                    <!-- Botón GPS más grande para móvil -->
                    <div class="d-grid gap-2 mb-3">
                        <button id="toggleGpsBtn" class="btn btn-outline-primary btn-lg" type="button">
                            <i class="fas fa-satellite-dish me-2"></i>
                            <span id="gpsButtonText">Activar GPS</span>
                        </button>
                    </div>

                    <!-- NUEVO: Botón para mostrar/ocultar instrucciones -->
                    <div class="d-grid gap-2 mb-3 d-block d-lg-none">
                        <button id="toggleInstructionsBtn" class="btn btn-info" type="button"
                            onclick="toggleInstructionPanel()">
                            <i class="fas fa-directions me-2"></i>
                            <span id="instructionsButtonText">Mostrar Instrucciones</span>
                        </button>
                    </div>

                    <!-- NUEVO: Botones de navegación por voz -->
                    <div class="d-grid gap-2 mb-3">
                        <button id="toggleVoiceBtn" class="btn btn-outline-secondary" type="button"
                            onclick="toggleVoiceInstructions()">
                            <i class="fas fa-volume-up me-2"></i>
                            <span id="voiceButtonText">Activar Voz</span>
                        </button>
                    </div>

                    <!-- Botones de acción optimizados -->
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-success btn-lg" data-bs-toggle="modal"
                            data-bs-target="#completeModal">
                            <i class="fas fa-flag-checkered me-2"></i>Completar Ruta
                        </button>

                        <button type="button" class="btn btn-warning" onclick="pauseNavigation()">
                            <i class="fas fa-pause me-2"></i>Pausar
                        </button>

                        <button type="button" class="btn btn-secondary" onclick="cancelRoute({{ completion.id }})">
                            <i class="fas fa-times me-2"></i>Cancelar Ruta
                        </button>
                    </div>

                    <!-- Información adicional -->
                    <hr>
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        La navegación funciona mejor con GPS activado y ubicación precisa.
                    </small>
                </div>
            </div>

            <!-- NUEVA SECCIÓN: Panel de estadísticas en tiempo real -->
            <div class="card shadow mt-3">
                <div class="card-header py-2">
                    <h6 class="m-0 font-weight-bold text-info">
                        <i class="fas fa-chart-line me-2"></i>Estadísticas del Viaje
                    </h6>
                </div>
                <div class="card-body p-3">
                    <div class="row text-center">
                        <div class="col-6 mb-2">
                            <small class="text-muted">Velocidad</small>
                            <div id="currentSpeed" class="h6 mb-0">0 km/h</div>
                        </div>
                        <div class="col-6 mb-2">
                            <small class="text-muted">Recorrida</small>
                            <div id="traveledDistance" class="h6 mb-0">0.0 km</div>
                        </div>
                        <div class="col-6 mb-2">
                            <small class="text-muted">Velocidad Prom.</small>
                            <div id="averageSpeed" class="h6 mb-0">0 km/h</div>
                        </div>
                        <div class="col-6 mb-2">
                            <small class="text-muted">Tiempo ETA</small>
                            <div id="etaTime" class="h6 mb-0">--:--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mapa de navegación responsive -->
        <div class="col-12 col-lg-8 mb-4">
            <div class="card shadow">
                <div class="card-header py-2 py-lg-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-map me-2"></i>Mapa de Navegación
                        </h6>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-primary" onclick="centerOnPosition()"
                                title="Mi ubicación">
                                <i class="fas fa-location-arrow"></i>
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="centerOnRoute()"
                                title="Ver ruta completa">
                                <i class="fas fa-route"></i>
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="toggleFullscreen()"
                                title="Pantalla completa">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="mapContainer" class="position-relative">
                        <!-- Altura adaptativa según dispositivo -->
                        <div id="navigationMap" style="height: 60vh; min-height: 400px; width: 100%;"></div>

                        <!-- NUEVO: Panel de navegación turn-by-turn mejorado -->
                        <div id="navigationPanel" class="position-absolute top-0 start-0 end-0 p-3 d-none d-lg-block"
                            style="z-index: 1000; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; display: none !important;">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <i id="turnIcon" class="fas fa-arrow-up fa-3x"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div id="turnInstruction" class="h5 mb-1">Calculando ruta...</div>
                                    <div id="turnDistance" class="opacity-75">Preparando navegación</div>
                                </div>
                                <div class="ms-3">
                                    <button class="btn btn-sm btn-outline-light" onclick="toggleNavigationPanel()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- NUEVO: Indicadores de dirección en el mapa -->
                        <div id="directionIndicator" class="position-absolute"
                            style="top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 999; display: none;">
                            <div class="bg-primary text-white rounded-circle p-3 shadow">
                                <i id="directionArrow" class="fas fa-arrow-up fa-2x"></i>
                            </div>
                        </div>

                        <!-- Overlay mejorado para móvil -->
                        <div id="navigationOverlay"
                            class="position-absolute top-0 end-0 m-2 bg-white bg-opacity-90 p-2 rounded shadow-sm d-none d-lg-block"
                            style="z-index: 1000; display: none !important;">
                            <small>
                                <strong>Tu posición:</strong><br>
                                <span id="overlayCoords" class="text-muted"></span><br>
                                <span id="overlayTime" class="text-muted"></span>
                            </small>
                        </div>

                        <!-- Controles de mapa para móvil -->
                        <div id="mapControls" class="position-absolute bottom-0 start-0 m-2" style="z-index: 1000;">
                            <div class="btn-group-vertical">
                                <button type="button" class="btn btn-sm btn-light" onclick="centerOnRoute()"
                                    title="Centrar en ruta">
                                    <i class="fas fa-crosshairs"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-light" onclick="centerOnPosition()"
                                    title="Mi ubicación" style="display: none;" id="centerPositionBtn">
                                    <i class="fas fa-location-arrow"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-light" onclick="toggleMapType()"
                                    title="Cambiar vista" id="mapTypeBtn">
                                    <i class="fas fa-layer-group"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-light" onclick="recalculateRoute()"
                                    title="Recalcular ruta" id="recalculateBtn">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Indicador de carga del mapa -->
                        <div id="mapLoading" class="position-absolute top-50 start-50 translate-middle">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando mapa...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para completar ruta - MANTENIDO IGUAL -->
<div class="modal fade" id="completeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Completar Ruta: {{ route.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Ruta iniciada:</strong> {{ completion.started_at|datetime_format }}<br>
                    <strong>Vehículo:</strong> {{ completion.vehicle.brand }} {{ completion.vehicle.model }}<br>
                    <strong>Combustible inicial:</strong> {{ completion.fuel_start }}/4
                </div>

                <div class="mb-3">
                    <label for="fuel_end_level" class="form-label">Nivel Final de Combustible:</label>
                    <div class="fuel-gauge">
                        <div class="fuel-options">
                            <input type="radio" id="fuel_end_1" name="fuel_end_level" value="1" required>
                            <label for="fuel_end_1" class="fuel-label">
                                <div class="fuel-bar">
                                    <div class="fuel-fill fuel-1"></div>
                                </div>
                                <span>1/4</span>
                            </label>

                            <input type="radio" id="fuel_end_2" name="fuel_end_level" value="2" required>
                            <label for="fuel_end_2" class="fuel-label">
                                <div class="fuel-bar">
                                    <div class="fuel-fill fuel-2"></div>
                                </div>
                                <span>2/4</span>
                            </label>

                            <input type="radio" id="fuel_end_3" name="fuel_end_level" value="3" required>
                            <label for="fuel_end_3" class="fuel-label">
                                <div class="fuel-bar">
                                    <div class="fuel-fill fuel-3"></div>
                                </div>
                                <span>3/4</span>
                            </label>

                            <input type="radio" id="fuel_end_4" name="fuel_end_level" value="4" required>
                            <label for="fuel_end_4" class="fuel-label">
                                <div class="fuel-bar">
                                    <div class="fuel-fill fuel-4"></div>
                                </div>
                                <span>4/4</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="completion_notes" class="form-label">Notas del recorrido (opcional):</label>
                    <textarea class="form-control" id="completion_notes" rows="3"
                        placeholder="Observaciones sobre el recorrido, incidentes, condiciones de la ruta, etc."></textarea>
                </div>

                <!-- Resumen del viaje -->
                <div id="tripSummary" class="alert alert-light" style="display: none;">
                    <h6 class="mb-2">Resumen del Viaje:</h6>
                    <div class="row text-center">
                        <div class="col-4">
                            <small class="text-muted">Tiempo total</small>
                            <div id="summaryTime">--:--</div>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Distancia</small>
                            <div id="summaryDistance">-- km</div>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Velocidad prom.</small>
                            <div id="summarySpeed">-- km/h</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="completeRouteBtn">
                    <i class="fas fa-flag-checkered me-2"></i>Completar Ruta
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast para notificaciones mejorado -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="navigationToast" class="toast" role="alert">
        <div class="toast-header">
            <i class="fas fa-directions text-primary me-2"></i>
            <strong class="me-auto">Navegación</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="navigationToastBody">
            <!-- Mensaje dinámico de navegación -->
        </div>
    </div>
</div>

<!-- NUEVO: Modal de alertas de navegación -->
<div class="modal fade" id="navigationAlertModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Alerta de Navegación
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="navigationAlertBody">
                <!-- Contenido de alerta dinámico -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Entendido</button>
            </div>
        </div>
    </div>
</div>

<!-- Indicador de conexión -->
<div id="connectionStatus"
    class="position-fixed top-0 start-50 translate-middle-x bg-danger text-white px-3 py-1 rounded-bottom"
    style="z-index: 9999; display: none;">
    <small><i class="fas fa-wifi-slash me-1"></i>Sin conexión</small>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
    /* NUEVOS ESTILOS PARA NAVEGACIÓN MEJORADA */

    /* Panel de instrucciones fijo */
    #navigationInstructions {
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
        from {
            transform: translateY(-100%);
        }

        to {
            transform: translateY(0);
        }
    }

    /* Indicadores de dirección */
    #directionIndicator {
        transition: all 0.3s ease;
        pointer-events: none;
    }

    #directionArrow {
        transition: transform 0.5s ease;
    }

    /* Panel de navegación mejorado */
    #navigationPanel {
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(10px);
    }

    /* Progreso de ruta */
    .progress {
        background-color: rgba(0, 0, 0, 0.1);
    }

    .progress-bar {
        transition: width 0.5s ease;
    }

    /* Alertas de navegación */
    .navigation-alert {
        background: linear-gradient(45deg, #ff6b6b, #feca57);
        color: white;
        padding: 10px;
        border-radius: 8px;
        margin: 10px 0;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }

        100% {
            opacity: 1;
        }
    }

    /* Botones de navegación mejorados */
    .navigation-btn {
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .navigation-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .navigation-btn.active {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
    }

    /* Instrucciones de voz */
    .voice-active {
        animation: soundWave 1s infinite;
    }

    @keyframes soundWave {

        0%,
        100% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.1);
        }
    }

    /* Ajustes responsive específicos para navegación */
    @media (max-width: 768px) {
        .container-fluid {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }

        #navigationMap {
            height: 55vh !important;
            min-height: 350px !important;
        }

        /* Asegurar espacio para panel de instrucciones */
        body.instructions-active {
            padding-top: 120px;
        }

        #navigationInstructions {
            top: 56px;
        }

        .card-body {
            padding: 1rem !important;
        }

        .btn-lg {
            padding: 0.75rem 1.5rem;
            font-size: 1.1rem;
        }

        /* Hacer los botones más fáciles de tocar */
        .fuel-label {
            padding: 0.5rem;
            margin: 0.25rem;
        }

        .fuel-bar {
            width: 35px;
            height: 70px;
        }
    }

    /* Estilos para el selector de combustible */
    .fuel-gauge {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        border: 1px solid #dee2e6;
    }

    .fuel-options {
        display: flex;
        gap: 10px;
        justify-content: center;
        align-items: end;
        flex-wrap: nowrap;
    }

    .fuel-label {
        cursor: pointer;
        text-align: center;
        transition: transform 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 10px;
        border-radius: 8px;
        min-width: 60px;
    }

    .fuel-label:hover {
        transform: scale(1.05);
        background-color: rgba(0, 123, 255, 0.1);
    }

    .fuel-bar {
        width: 30px;
        height: 60px;
        border: 2px solid #333;
        border-radius: 15px;
        background: #e9ecef;
        position: relative;
        margin-bottom: 8px;
        overflow: hidden;
    }

    .fuel-fill {
        position: absolute;
        bottom: 0;
        width: 100%;
        transition: all 0.3s ease;
    }

    .fuel-1 {
        height: 25%;
        background: linear-gradient(180deg, #dc3545 0%, #c82333 100%);
        border-radius: 0 0 13px 13px;
    }

    .fuel-2 {
        height: 50%;
        background: linear-gradient(180deg, #fd7e14 0%, #e8670e 100%);
        border-radius: 0 0 13px 13px;
    }

    .fuel-3 {
        height: 75%;
        background: linear-gradient(180deg, #ffc107 0%, #e0a800 100%);
        border-radius: 0 0 13px 13px;
    }

    .fuel-4 {
        height: 100%;
        background: linear-gradient(180deg, #28a745 0%, #1e7e34 100%);
        border-radius: 13px;
    }

    input[type="radio"] {
        display: none;
    }

    input[type="radio"]:checked+.fuel-label {
        transform: scale(1.1);
        background-color: rgba(0, 123, 255, 0.2);
    }

    input[type="radio"]:checked+.fuel-label .fuel-bar {
        box-shadow: 0 0 15px rgba(0, 123, 255, 0.6);
        border-color: #007bff;
    }

    input[type="radio"]:checked+.fuel-label span {
        font-weight: bold;
        color: #007bff;
    }

    .fuel-label span {
        font-size: 0.9rem;
        color: #6c757d;
        transition: all 0.3s ease;
    }

    /* Estilos para el estado GPS */
    .badge {
        font-size: 0.8em;
    }

    #navigationOverlay {
        backdrop-filter: blur(5px);
        max-width: 200px;
    }

    /* Indicador de precisión GPS */
    #gpsAccuracy {
        font-size: 0.75rem;
    }

    /* Animación para el estado activo del GPS */
    .gps-active {
        animation: pulse-gps 2s infinite;
    }

    @keyframes pulse-gps {
        0% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }

        100% {
            opacity: 1;
        }
    }

    /* Controles del mapa */
    #mapControls .btn {
        width: 40px;
        height: 40px;
        margin-bottom: 2px;
        border: 1px solid #ddd;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(5px);
    }

    #mapControls .btn:hover {
        background: rgba(255, 255, 255, 1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    /* Loading spinner */
    #mapLoading {
        z-index: 999;
    }

    /* Marcadores del mapa */
    .route-marker {
        background: white;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .position-marker {
        background: #007bff;
        border: 3px solid white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        animation: pulse-position 2s infinite;
    }

    @keyframes pulse-position {
        0% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.2);
        }

        100% {
            transform: scale(1);
        }
    }

    /* Marcador de dirección especial */
    .direction-marker {
        background: linear-gradient(45deg, #28a745, #20c997);
        border: 3px solid white;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 3px 12px rgba(40, 167, 69, 0.4);
        animation: direction-pulse 2s infinite;
    }

    @keyframes direction-pulse {
        0% {
            transform: scale(1) rotate(0deg);
        }

        50% {
            transform: scale(1.1) rotate(180deg);
        }

        100% {
            transform: scale(1) rotate(360deg);
        }
    }

    /* Mejoras de accesibilidad */
    .btn:focus {
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    /* Indicador de conexión */
    #connectionStatus {
        transition: all 0.3s ease;
    }

    /* Estilos para modo nocturno */
    @media (prefers-color-scheme: dark) {
        .fuel-gauge {
            background: #2d3748;
            border-color: #4a5568;
        }

        .fuel-label:hover {
            background-color: rgba(66, 153, 225, 0.1);
        }

        #navigationOverlay {
            background: rgba(45, 55, 72, 0.9) !important;
            color: white;
        }

        #navigationInstructions {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%) !important;
        }

        #navigationPanel {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%) !important;
        }
    }

    /* Estilos específicos para pantallas muy pequeñas */
    @media (max-width: 576px) {
        #navigationOverlay {
            font-size: 0.8rem;
            padding: 0.5rem;
            max-width: 150px;
        }

        .fuel-options {
            gap: 5px;
        }

        .fuel-bar {
            width: 25px;
            height: 50px;
        }

        .fuel-label {
            min-width: 50px;
            padding: 5px;
        }

        #navigationInstructions {
            padding: 1rem;
        }

        #instructionIcon {
            font-size: 1.5rem;
        }

        /* Ajustar tamaño de botones para dispositivos táctiles */
        .btn {
            min-height: 44px;
            min-width: 44px;
        }

        /* Mejorar controles del mapa en móvil */
        #mapControls .btn {
            width: 44px;
            height: 44px;
            font-size: 1.1rem;
        }
    }

    /* Animaciones adicionales para mejor experiencia */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Aplicar animaciones a elementos que aparecen */
    #routeProgress {
        animation: fadeInUp 0.5s ease-out;
    }

    #navigationInstructions {
        animation: fadeInDown 0.3s ease-out;
    }

    #nextInstructionCard {
        animation: fadeInUp 0.4s ease-out;
    }

    /* Estilos para estados de carga */
    .loading-state {
        opacity: 0.6;
        pointer-events: none;
        position: relative;
    }

    .loading-state::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        margin: -10px 0 0 -10px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        z-index: 1001;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Mejoras para el panel de estadísticas */
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 1rem;
        margin: 0.5rem 0;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .stats-value {
        font-size: 1.5rem;
        font-weight: bold;
        margin: 0;
    }

    .stats-label {
        font-size: 0.85rem;
        opacity: 0.9;
        margin: 0;
    }

    /* Estilos para alertas de navegación personalizadas */
    .navigation-alert-success {
        background: linear-gradient(45deg, #28a745, #20c997);
        border-left: 4px solid #1e7e34;
    }

    .navigation-alert-warning {
        background: linear-gradient(45deg, #ffc107, #fd7e14);
        border-left: 4px solid #e0a800;
    }

    .navigation-alert-danger {
        background: linear-gradient(45deg, #dc3545, #e74c3c);
        border-left: 4px solid #c82333;
    }

    .navigation-alert-info {
        background: linear-gradient(45deg, #17a2b8, #007bff);
        border-left: 4px solid #138496;
    }

    /* Estilos para botones de acción rápida */
    .quick-action-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(45deg, #007bff, #0056b3);
        color: white;
        border: none;
        box-shadow: 0 4px 20px rgba(0, 123, 255, 0.3);
        z-index: 1050;
        transition: all 0.3s ease;
    }

    .quick-action-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 25px rgba(0, 123, 255, 0.4);
    }

    .quick-action-btn i {
        font-size: 1.5rem;
    }

    /* Ocultar en desktop si no es necesario */
    @media (min-width: 769px) {
        .quick-action-btn {
            display: none;
        }
    }

    /* Mejoras para la vista de pantalla completa */
    .modal-fullscreen .modal-body {
        padding: 0 !important;
        height: 100vh;
    }

    .modal-fullscreen #fullscreenMap {
        height: 100% !important;
        width: 100% !important;
    }

    /* Estilos para el indicador de precisión GPS */
    .gps-precision-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-left: 5px;
        animation: pulse 2s infinite;
    }

    .gps-precision-high {
        background-color: #28a745;
    }

    .gps-precision-medium {
        background-color: #ffc107;
    }

    .gps-precision-low {
        background-color: #dc3545;
    }

    /* Personalización del scrollbar para webkit browsers */
    .navigation-panel::-webkit-scrollbar {
        width: 8px;
    }

    .navigation-panel::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
    }

    .navigation-panel::-webkit-scrollbar-thumb {
        background: rgba(0, 123, 255, 0.6);
        border-radius: 4px;
    }

    .navigation-panel::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 123, 255, 0.8);
    }

    /* Último ajuste para asegurar compatibilidad */
    * {
        box-sizing: border-box;
    }

    /* Asegurar que los elementos de navegación no interfieran con el flujo normal */
    .navigation-overlay {
        pointer-events: none;
    }

    .navigation-overlay .interactive {
        pointer-events: auto;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // Variables existentes mantenidas
    let gpsActive = false;
    let gpsWatchId = null;
    let lastPosition = null;
    let map = null;
    let routeLayer = null;
    let positionMarker = null;
    let fullscreenMap = null;
    let startTime = new Date('{{ completion.started_at.isoformat() }}');
    let elapsedInterval = null;
    let traveledDistance = 0;
    let previousPosition = null;
    let currentMapType = 'street';

    // Variables para tracking (mantenidas)
    let trackingPoints = [];
    let lastTrackingUpdate = null;

    // NUEVAS VARIABLES PARA NAVEGACIÓN MEJORADA
    let routePoints = [];
    let currentRouteIndex = 0;
    let voiceEnabled = false;
    let instructionsPanelVisible = false;
    let navigationActive = false;
    let currentInstruction = null;
    let nextInstruction = null;
    let routeProgress = 0;
    let estimatedArrival = null;
    let averageSpeed = 0;
    let speedReadings = [];
    let lastInstructionTime = 0;
    let speechSynthesis = window.speechSynthesis;

    // Configuración de navegación
    const NAVIGATION_CONFIG = {
        INSTRUCTION_DISTANCE_THRESHOLD: 100, // metros para mostrar próxima instrucción
        VOICE_REPEAT_INTERVAL: 30000, // repetir instrucciones cada 30 segundos
        PROGRESS_UPDATE_INTERVAL: 5000, // actualizar progreso cada 5 segundos
        RECALCULATE_THRESHOLD: 50, // metros fuera de ruta para recalcular
        MIN_SPEED_FOR_INSTRUCTIONS: 2, // km/h mínimo para dar instrucciones
        ARRIVAL_THRESHOLD: 20 // metros para considerar llegada
    };

    $(document).ready(function () {
        console.log('Enhanced Navigation page loaded');

        // Inicializar mapa
        initializeMap();

        // Inicializar contador de tiempo
        startElapsedTimer();

        // Inicializar navegación
        initializeNavigation();

        // Handler para activar/desactivar GPS
        $('#toggleGpsBtn').on('click', function () {
            if (gpsActive) {
                stopGPS();
            } else {
                startGPS();
            }
        });

        // Handler para completar ruta
        $('#completeRouteBtn').on('click', function (e) {
            e.preventDefault();
            completeRoute();
        });

        // Verificar soporte de geolocalización
        if (!navigator.geolocation) {
            showNavigationToast('Tu navegador no soporta geolocalización', 'warning');
            $('#toggleGpsBtn').prop('disabled', true).html('<i class="fas fa-exclamation-triangle me-2"></i>GPS No Disponible');
        }

        // Verificar soporte de síntesis de voz
        if (!speechSynthesis) {
            $('#toggleVoiceBtn').prop('disabled', true).html('<i class="fas fa-volume-mute me-2"></i>Voz No Disponible');
        }

        // Manejar visibilidad de la página
        document.addEventListener('visibilitychange', handleVisibilityChange);

        // Manejar conexión de red
        window.addEventListener('online', handleConnectionChange);
        window.addEventListener('offline', handleConnectionChange);

        // Auto-activar GPS si es posible
        if (navigator.geolocation && window.location.search.includes('auto_gps=true')) {
            setTimeout(startGPS, 1000);
        }

        // Configurar modal de completar ruta
        $('#completeModal').on('show.bs.modal', function () {
            updateTripSummary();
        });

        // Inicializar actualización de progreso
        setInterval(updateNavigationProgress, NAVIGATION_CONFIG.PROGRESS_UPDATE_INTERVAL);
    });

    function initializeNavigation() {
        console.log('Initializing enhanced navigation system');

        // Ocultar panel de instrucciones inicialmente en móvil
        if (window.innerWidth <= 768) {
            $('#navigationInstructions').hide();
            $('body').removeClass('instructions-active');
        }

        // Mostrar panel de navegación en desktop
        if (window.innerWidth > 768) {
            $('#navigationPanel').show();
        }

        // Configurar eventos de navegación
        setupNavigationEvents();
    }

    function setupNavigationEvents() {
        // Event listeners para controles de navegación
        $(document).on('click', '[data-navigation-action]', function () {
            const action = $(this).data('navigation-action');
            handleNavigationAction(action);
        });

        // Detectar cambios de orientación en móvil
        window.addEventListener('orientationchange', function () {
            setTimeout(() => {
                if (map) {
                    map.invalidateSize();
                    if (routeLayer) {
                        map.fitBounds(routeLayer.getBounds(), { padding: [20, 20] });
                    }
                }
            }, 500);
        });
    }

    function handleNavigationAction(action) {
        switch (action) {
            case 'toggle-instructions':
                toggleInstructionPanel();
                break;
            case 'toggle-voice':
                toggleVoiceInstructions();
                break;
            case 'recalculate':
                recalculateRoute();
                break;
            case 'center-position':
                centerOnPosition();
                break;
            case 'center-route':
                centerOnRoute();
                break;
        }
    }

    function initializeMap() {
        try {
            $('#mapLoading').show();

            // Inicializar el mapa
            map = L.map('navigationMap', {
                zoomControl: true,
                attributionControl: false
            }).setView([-3.8167, -78.7500], 13);

            // Añadir capa de tiles
            updateMapLayer();

            // Cargar la ruta desde el backend
            loadRouteData();

            // Ocultar loading después de un tiempo
            setTimeout(() => {
                $('#mapLoading').hide();
            }, 2000);

        } catch (error) {
            console.error('Error initializing map:', error);
            $('#mapLoading').html('<div class="text-danger">Error cargando mapa</div>');
        }
    }

    function loadRouteData() {
        console.log('Loading route data for navigation');

        $.ajax({
            url: '/api/route/navigation-data/{{ route.id }}',
            method: 'GET',
            timeout: 10000,
            success: function (response) {
                if (response.coordinates && response.coordinates.length > 0) {
                    console.log('Route coordinates loaded:', response.coordinates.length, 'points');
                    routePoints = response.coordinates;
                    displayRoute(response.coordinates);

                    // Inicializar sistema de navegación
                    initializeRouteNavigation();
                } else {
                    console.warn('No coordinates found in route data');
                    loadRouteFromGPXFile();
                }
            },
            error: function (xhr, status, error) {
                console.warn('Failed to load route from API, trying GPX file method');
                loadRouteFromGPXFile();
            }
        });
    }

    function initializeRouteNavigation() {
        if (routePoints.length < 2) {
            console.warn('Insufficient route points for navigation');
            return;
        }

        navigationActive = true;
        console.log('Navigation system activated with', routePoints.length, 'route points');

        // Generar instrucciones de navegación
        generateNavigationInstructions();

        // Mostrar primera instrucción
        updateCurrentInstruction();

        // Mostrar progreso inicial
        $('#routeProgress').show();
        updateNavigationProgress();

        showNavigationToast('Sistema de navegación activado. Active el GPS para comenzar.', 'success');
    }

    function generateNavigationInstructions() {
        console.log('Generating navigation instructions');

        if (routePoints.length < 2) return;

        // Instrucción inicial
        currentInstruction = {
            type: 'start',
            instruction: 'Diríjase hacia el punto de inicio de la ruta',
            icon: 'fas fa-play',
            distance: 0,
            coordinates: routePoints[0]
        };

        // Para simplificar, generamos instrucciones básicas cada cierta distancia
        const instructions = [];

        for (let i = 0; i < routePoints.length - 1; i++) {
            const currentPoint = routePoints[i];
            const nextPoint = routePoints[i + 1];

            // Calcular dirección (simplificado)
            const bearing = calculateBearing(currentPoint, nextPoint);
            const direction = getDirectionFromBearing(bearing);

            instructions.push({
                type: 'continue',
                instruction: `Continúe ${direction.text}`,
                icon: direction.icon,
                distance: calculateDistance(currentPoint[0], currentPoint[1], nextPoint[0], nextPoint[1]) * 1000,
                coordinates: currentPoint,
                nextCoordinates: nextPoint
            });
        }

        // Instrucción final
        instructions.push({
            type: 'arrival',
            instruction: 'Ha llegado a su destino',
            icon: 'fas fa-flag-checkered',
            distance: 0,
            coordinates: routePoints[routePoints.length - 1]
        });

        window.navigationInstructions = instructions;
        console.log('Generated', instructions.length, 'navigation instructions');
    }

    function calculateBearing(point1, point2) {
        const lat1 = point1[0] * Math.PI / 180;
        const lat2 = point2[0] * Math.PI / 180;
        const deltaLng = (point2[1] - point1[1]) * Math.PI / 180;

        const x = Math.sin(deltaLng) * Math.cos(lat2);
        const y = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(deltaLng);

        const bearing = Math.atan2(x, y) * 180 / Math.PI;
        return (bearing + 360) % 360;
    }

    function getDirectionFromBearing(bearing) {
        if (bearing >= 337.5 || bearing < 22.5) {
            return { text: 'hacia el norte', icon: 'fas fa-arrow-up' };
        } else if (bearing >= 22.5 && bearing < 67.5) {
            return { text: 'hacia el noreste', icon: 'fas fa-arrow-up' };
        } else if (bearing >= 67.5 && bearing < 112.5) {
            return { text: 'hacia el este', icon: 'fas fa-arrow-right' };
        } else if (bearing >= 112.5 && bearing < 157.5) {
            return { text: 'hacia el sureste', icon: 'fas fa-arrow-down' };
        } else if (bearing >= 157.5 && bearing < 202.5) {
            return { text: 'hacia el sur', icon: 'fas fa-arrow-down' };
        } else if (bearing >= 202.5 && bearing < 247.5) {
            return { text: 'hacia el suroeste', icon: 'fas fa-arrow-down' };
        } else if (bearing >= 247.5 && bearing < 292.5) {
            return { text: 'hacia el oeste', icon: 'fas fa-arrow-left' };
        } else {
            return { text: 'hacia el noroeste', icon: 'fas fa-arrow-up' };
        }
    }

    function updateCurrentInstruction() {
        if (!currentInstruction) return;

        // Actualizar paneles de instrucciones
        $('#turnInstruction').text(currentInstruction.instruction);
        $('#turnIcon').removeClass().addClass(currentInstruction.icon + ' fa-3x');
        $('#currentInstruction').text(currentInstruction.instruction);
        $('#instructionIcon').removeClass().addClass(currentInstruction.icon + ' fa-2x');

        // Actualizar distancia si está disponible
        if (currentInstruction.distance > 0) {
            const distanceText = currentInstruction.distance > 1000 ?
                `en ${(currentInstruction.distance / 1000).toFixed(1)} km` :
                `en ${Math.round(currentInstruction.distance)} metros`;

            $('#turnDistance').text(distanceText);
            $('#instructionDistance').text(distanceText);
        } else {
            $('#turnDistance').text('Siga las indicaciones');
            $('#instructionDistance').text('Siga las indicaciones');
        }

        // Reproducir instrucción por voz si está habilitada
        if (voiceEnabled) {
            speakInstruction(currentInstruction.instruction);
        }

        console.log('Current instruction updated:', currentInstruction.instruction);
    }

    function speakInstruction(text) {
        if (!speechSynthesis || !voiceEnabled) return;

        // Cancelar cualquier síntesis anterior
        speechSynthesis.cancel();

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'es-ES';
        utterance.rate = 0.9;
        utterance.pitch = 1;
        utterance.volume = 0.8;

        speechSynthesis.speak(utterance);
    }

    function toggleInstructionPanel() {
        instructionsPanelVisible = !instructionsPanelVisible;

        if (instructionsPanelVisible) {
            $('#navigationInstructions').slideDown();
            $('body').addClass('instructions-active');
            $('#instructionsButtonText').text('Ocultar Instrucciones');
        } else {
            $('#navigationInstructions').slideUp();
            $('body').removeClass('instructions-active');
            $('#instructionsButtonText').text('Mostrar Instrucciones');
        }
    }

    function toggleVoiceInstructions() {
        voiceEnabled = !voiceEnabled;

        if (voiceEnabled) {
            $('#toggleVoiceBtn').addClass('btn-success').removeClass('btn-outline-secondary');
            $('#voiceButtonText').text('Voz Activada');
            $('#toggleVoiceBtn i').addClass('voice-active');
            showNavigationToast('Instrucciones por voz activadas', 'success');

            // Reproducir instrucción actual
            if (currentInstruction) {
                speakInstruction(currentInstruction.instruction);
            }
        } else {
            $('#toggleVoiceBtn').removeClass('btn-success').addClass('btn-outline-secondary');
            $('#voiceButtonText').text('Activar Voz');
            $('#toggleVoiceBtn i').removeClass('voice-active');
            speechSynthesis.cancel();
            showNavigationToast('Instrucciones por voz desactivadas', 'info');
        }
    }

    function updateNavigationProgress() {
        if (!navigationActive || !lastPosition || routePoints.length < 2) return;

        try {
            // Encontrar el punto más cercano en la ruta
            let closestPointIndex = findClosestRoutePoint(lastPosition);

            // Calcular progreso como porcentaje
            routeProgress = (closestPointIndex / (routePoints.length - 1)) * 100;
            routeProgress = Math.min(100, Math.max(0, routeProgress));

            // Actualizar barra de progreso
            $('#progressBar').css('width', routeProgress + '%');
            $('#progressText').text(Math.round(routeProgress) + '%');

            // Calcular distancia restante
            const remainingPoints = routePoints.slice(closestPointIndex);
            let remainingDistance = 0;

            for (let i = 0; i < remainingPoints.length - 1; i++) {
                remainingDistance += calculateDistance(
                    remainingPoints[i][0], remainingPoints[i][1],
                    remainingPoints[i + 1][0], remainingPoints[i + 1][1]
                );
            }

            $('#remainingDistance').text(remainingDistance.toFixed(1) + ' km');

            // Calcular ETA basado en velocidad promedio
            if (averageSpeed > 0) {
                const etaHours = remainingDistance / averageSpeed;
                const etaTime = new Date(Date.now() + etaHours * 3600000);
                $('#estimatedArrival').text(etaTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
                $('#etaTime').text(etaTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
            }

            // Verificar si necesitamos actualizar la instrucción actual
            updateInstructionBasedOnPosition(closestPointIndex);

            // Verificar si hemos llegado al destino
            const distanceToDestination = calculateDistance(
                lastPosition.lat, lastPosition.lng,
                routePoints[routePoints.length - 1][0], routePoints[routePoints.length - 1][1]
            ) * 1000;

            if (distanceToDestination < NAVIGATION_CONFIG.ARRIVAL_THRESHOLD) {
                handleArrival();
            }

        } catch (error) {
            console.error('Error updating navigation progress:', error);
        }
    }

    function findClosestRoutePoint(position) {
        let closestIndex = 0;
        let minDistance = Infinity;

        for (let i = 0; i < routePoints.length; i++) {
            const distance = calculateDistance(
                position.lat, position.lng,
                routePoints[i][0], routePoints[i][1]
            );

            if (distance < minDistance) {
                minDistance = distance;
                closestIndex = i;
            }
        }

        return closestIndex;
    }

    function updateInstructionBasedOnPosition(closestPointIndex) {
        if (!window.navigationInstructions || closestPointIndex >= window.navigationInstructions.length) return;

        const newInstruction = window.navigationInstructions[closestPointIndex];

        if (!currentInstruction || currentInstruction.instruction !== newInstruction.instruction) {
            currentInstruction = newInstruction;
            updateCurrentInstruction();

            // Mostrar próxima instrucción si existe
            if (closestPointIndex + 1 < window.navigationInstructions.length) {
                nextInstruction = window.navigationInstructions[closestPointIndex + 1];
                updateNextInstruction();
            }
        }
    }

    function updateNextInstruction() {
        if (!nextInstruction) {
            $('#nextInstructionCard').hide();
            return;
        }

        $('#nextInstructionText').text(nextInstruction.instruction);
        $('#nextInstructionIcon').removeClass().addClass(nextInstruction.icon + ' fa-lg');

        if (nextInstruction.distance > 0) {
            const distanceText = nextInstruction.distance > 1000 ?
                `en ${(nextInstruction.distance / 1000).toFixed(1)} km` :
                `en ${Math.round(nextInstruction.distance)} metros`;
            $('#nextInstructionDistance').text(distanceText);
        }

        $('#nextInstructionCard').show();
    }

    function handleArrival() {
        if (currentInstruction && currentInstruction.type !== 'arrival') {
            currentInstruction = {
                type: 'arrival',
                instruction: '¡Ha llegado a su destino!',
                icon: 'fas fa-flag-checkered',
                distance: 0
            };

            updateCurrentInstruction();
            showNavigationToast('¡Destino alcanzado! Puede completar la ruta.', 'success');

            // Vibrar si está disponible
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
            }
        }
    }

    function recalculateRoute() {
        if (!lastPosition || routePoints.length < 2) {
            showNavigationToast('No se puede recalcular sin posición GPS', 'warning');
            return;
        }

        showNavigationToast('Recalculando ruta...', 'info');

        // Encontrar el punto más cercano y reiniciar desde ahí
        const closestIndex = findClosestRoutePoint(lastPosition);
        currentRouteIndex = closestIndex;

        // Regenerar instrucciones desde el punto actual
        generateNavigationInstructions();
        updateCurrentInstruction();

        showNavigationToast('Ruta recalculada', 'success');
    }

    // Función existente de GPS con mejoras para navegación
    function onGPSSuccess(position) {
        const coords = position.coords;
        lastPosition = {
            lat: coords.latitude,
            lng: coords.longitude,
            accuracy: coords.accuracy,
            speed: coords.speed || 0,
            heading: coords.heading || 0,
            timestamp: new Date()
        };

        console.log('GPS position updated:', lastPosition);

        // Calcular distancia recorrida (código existente mantenido)
        if (previousPosition) {
            const distance = calculateDistance(
                previousPosition.lat, previousPosition.lng,
                lastPosition.lat, lastPosition.lng
            );

            if (distance < 0.1) {
                traveledDistance += distance;
            }
        }

        previousPosition = lastPosition;

        // Actualizar velocidad promedio
        updateAverageSpeed(lastPosition.speed || 0);

        // Actualizar UI (código existente)
        updatePositionDisplay(lastPosition);
        updateMapPosition(lastPosition);
        updateStatistics(lastPosition);

        // Nuevas funciones de navegación
        if (navigationActive) {
            updateNavigationProgress();
            checkNavigationAlerts();
        }

        // Enviar al servidor (código existente mantenido)
        const now = Date.now();
        if (!lastTrackingUpdate || (now - lastTrackingUpdate) > 30000) {
            sendPositionUpdate(lastPosition);
            lastTrackingUpdate = now;
        }

        // Almacenar punto para el tracking (código existente mantenido)
        trackingPoints.push({
            lat: lastPosition.lat,
            lng: lastPosition.lng,
            timestamp: lastPosition.timestamp.toISOString(),
            speed: lastPosition.speed,
            accuracy: lastPosition.accuracy
        });
    }

    function updateAverageSpeed(currentSpeed) {
        // Convertir m/s a km/h
        const speedKmh = currentSpeed * 3.6;

        // Mantener solo las últimas 10 lecturas para el promedio
        speedReadings.push(speedKmh);
        if (speedReadings.length > 10) {
            speedReadings.shift();
        }

        // Calcular promedio
        averageSpeed = speedReadings.reduce((a, b) => a + b, 0) / speedReadings.length;
        $('#averageSpeed').text(averageSpeed.toFixed(1) + ' km/h');
    }

    function checkNavigationAlerts() {
        if (!lastPosition) return;

        // Verificar si estamos demasiado lejos de la ruta
        const closestPointIndex = findClosestRoutePoint(lastPosition);
        const closestPoint = routePoints[closestPointIndex];

        const distanceToRoute = calculateDistance(
            lastPosition.lat, lastPosition.lng,
            closestPoint[0], closestPoint[1]
        ) * 1000; // convertir a metros

        if (distanceToRoute > NAVIGATION_CONFIG.RECALCULATE_THRESHOLD) {
            showNavigationAlert(
                'Fuera de Ruta',
                `Está ${Math.round(distanceToRoute)} metros fuera de la ruta planificada. ¿Desea recalcular?`,
                'warning',
                [
                    { text: 'Recalcular', action: 'recalculateRoute()' },
                    { text: 'Continuar', action: 'dismissAlert()' }
                ]
            );
        }

        // Verificar velocidad baja por mucho tiempo
        const currentSpeed = (lastPosition.speed || 0) * 3.6;
        if (currentSpeed < NAVIGATION_CONFIG.MIN_SPEED_FOR_INSTRUCTIONS) {
            if (!window.lowSpeedAlertShown) {
                setTimeout(() => {
                    if ((lastPosition.speed || 0) * 3.6 < NAVIGATION_CONFIG.MIN_SPEED_FOR_INSTRUCTIONS) {
                        showNavigationAlert(
                            'Velocidad Baja',
                            'Su velocidad es muy baja. ¿Está detenido o necesita ayuda?',
                            'info',
                            [{ text: 'Continuar', action: 'dismissAlert()' }]
                        );
                    }
                }, 60000); // 1 minuto
                window.lowSpeedAlertShown = true;
            }
        } else {
            window.lowSpeedAlertShown = false;
        }
    }

    function showNavigationAlert(title, message, type, buttons) {
        $('#navigationAlertModal .modal-title').html(`<i class="fas fa-exclamation-triangle me-2"></i>${title}`);
        $('#navigationAlertBody').text(message);

        // Limpiar botones anteriores
        const footer = $('#navigationAlertModal .modal-footer');
        footer.empty();

        // Agregar nuevos botones
        buttons.forEach(button => {
            const btn = $(`<button type="button" class="btn btn-primary" onclick="${button.action}">${button.text}</button>`);
            footer.append(btn);
        });

        $('#navigationAlertModal').modal('show');
    }

    function dismissAlert() {
        $('#navigationAlertModal').modal('hide');
    }

    function showNavigationToast(message, type = 'info') {
        const toastEl = $('#navigationToast');
        const toastBody = $('#navigationToastBody');

        let bgClass = 'bg-info';
        let icon = 'fas fa-info-circle';

        switch (type) {
            case 'success':
                bgClass = 'bg-success text-white';
                icon = 'fas fa-check-circle';
                break;
            case 'error':
            case 'danger':
                bgClass = 'bg-danger text-white';
                icon = 'fas fa-exclamation-triangle';
                break;
            case 'warning':
                bgClass = 'bg-warning';
                icon = 'fas fa-exclamation-triangle';
                break;
        }

        toastEl.removeClass('bg-info bg-success bg-danger bg-warning text-white').addClass(bgClass);
        toastEl.find('.toast-header i').removeClass().addClass(icon + ' me-2');
        toastBody.text(message);

        const toast = new bootstrap.Toast(toastEl[0], {
            delay: type === 'error' ? 5000 : 3000
        });
        toast.show();
    }

    // Funciones existentes mantenidas con mejoras menores
    function updateMapLayer() {
        map.eachLayer(function (layer) {
            if (layer._url) {
                map.removeLayer(layer);
            }
        });

        let tileUrl, attribution;

        switch (currentMapType) {
            case 'satellite':
                tileUrl = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
                attribution = '© Esri';
                break;
            case 'terrain':
                tileUrl = 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png';
                attribution = '© OpenTopoMap';
                break;
            default: // street
                tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
                attribution = '© OpenStreetMap contributors';
        }

        L.tileLayer(tileUrl, {
            maxZoom: 19,
            detectRetina: true,
            attribution: attribution
        }).addTo(map);
    }

    function displayRoute(coordinates) {
        if (!map || !coordinates || coordinates.length === 0) return;

        try {
            if (routeLayer) {
                map.removeLayer(routeLayer);
            }

            routeLayer = L.polyline(coordinates, {
                color: '#007bff',
                weight: 4,
                opacity: 0.8
            }).addTo(map);

            map.fitBounds(routeLayer.getBounds(), { padding: [20, 20] });

            if (coordinates.length > 1) {
                L.marker(coordinates[0], {
                    icon: L.divIcon({
                        html: '<div class="route-marker"><i class="fas fa-play text-success"></i></div>',
                        className: 'route-marker-start',
                        iconSize: [30, 30]
                    })
                }).addTo(map).bindPopup('Inicio de ruta');

                L.marker(coordinates[coordinates.length - 1], {
                    icon: L.divIcon({
                        html: '<div class="route-marker"><i class="fas fa-flag-checkered text-danger"></i></div>',
                        className: 'route-marker-end',
                        iconSize: [30, 30]
                    })
                }).addTo(map).bindPopup('Fin de ruta');
            }

        } catch (error) {
            console.error('Error displaying route:', error);
        }
    }

    function startElapsedTimer() {
        elapsedInterval = setInterval(updateElapsedTime, 1000);
        updateElapsedTime();
    }

    function updateElapsedTime() {
        const now = new Date();
        const elapsed = Math.floor((now - startTime) / 1000);

        const hours = Math.floor(elapsed / 3600);
        const minutes = Math.floor((elapsed % 3600) / 60);
        const seconds = elapsed % 60;

        const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        $('#elapsedTime').text(timeString);
    }

    function startGPS() {
        if (!navigator.geolocation) {
            showNavigationToast('Geolocalización no disponible', 'error');
            return;
        }

        const options = {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 30000
        };

        showNavigationToast('Activando GPS...', 'info');

        gpsWatchId = navigator.geolocation.watchPosition(
            onGPSSuccess,
            onGPSError,
            options
        );

        gpsActive = true;
        updateGPSUI();
    }

    function stopGPS() {
        if (gpsWatchId !== null) {
            navigator.geolocation.clearWatch(gpsWatchId);
            gpsWatchId = null;
        }

        gpsActive = false;
        updateGPSUI();
        showNavigationToast('GPS desactivado', 'info');

        $('#currentPosition').hide();
        $('#navigationOverlay').hide();
        $('#centerPositionBtn').hide();
        $('#navigationPanel').hide();

        if (positionMarker && map) {
            map.removeLayer(positionMarker);
            positionMarker = null;
        }
    }

    function onGPSError(error) {
        let errorMessage = 'Error de GPS';

        switch (error.code) {
            case error.PERMISSION_DENIED:
                errorMessage = 'Permiso de ubicación denegado';
                break;
            case error.POSITION_UNAVAILABLE:
                errorMessage = 'Ubicación no disponible';
                break;
            case error.TIMEOUT:
                errorMessage = 'Timeout de GPS';
                break;
        }

        console.error('GPS Error:', error);
        $('#gpsStatus').removeClass('bg-success gps-active').addClass('bg-danger').html('<i class="fas fa-exclamation-triangle me-1"></i>Error GPS');
        showNavigationToast(errorMessage, 'error');
    }

    function updateGPSUI() {
        const btn = $('#toggleGpsBtn');
        const status = $('#gpsStatus');
        const buttonText = $('#gpsButtonText');

        if (gpsActive) {
            btn.removeClass('btn-outline-primary').addClass('btn-outline-danger');
            buttonText.text('Desactivar GPS');
            status.removeClass('bg-secondary bg-danger').addClass('bg-success gps-active')
                .html('<i class="fas fa-satellite-dish me-1"></i>GPS Activo');
        } else {
            btn.removeClass('btn-outline-danger').addClass('btn-outline-primary');
            buttonText.text('Activar GPS');
            status.removeClass('bg-success bg-danger gps-active').addClass('bg-secondary')
                .html('<i class="fas fa-satellite-dish me-1"></i>GPS Inactivo');
        }
    }

    function updatePositionDisplay(position) {
        const coordsText = `${position.lat.toFixed(6)}, ${position.lng.toFixed(6)}`;
        const timeText = position.timestamp.toLocaleTimeString();
        const accuracyText = `±${Math.round(position.accuracy)}m`;

        $('#coordinates').html(`${coordsText}<br><small class="text-muted">${accuracyText}</small>`);
        $('#lastUpdate').text(`Actualizado: ${timeText}`);
        $('#overlayCoords').text(coordsText);
        $('#overlayTime').text(timeText);

        $('#gpsAccuracy').text(accuracyText).show();
        $('#currentPosition').show();
        $('#navigationOverlay').show();
        $('#centerPositionBtn').show();
    }

    function updateMapPosition(position) {
        if (!map) return;

        try {
            if (positionMarker) {
                map.removeLayer(positionMarker);
            }

            positionMarker = L.marker([position.lat, position.lng], {
                icon: L.divIcon({
                    html: '<div class="position-marker"><i class="fas fa-location-arrow text-white"></i></div>',
                    className: 'position-marker-icon',
                    iconSize: [20, 20]
                })
            }).addTo(map);

            if (position.accuracy < 50) {
                L.circle([position.lat, position.lng], {
                    radius: position.accuracy,
                    color: '#007bff',
                    fillColor: '#007bff',
                    fillOpacity: 0.1,
                    weight: 1
                }).addTo(map);
            }

            // Mostrar panel de navegación
            if (navigationActive) {
                $('#navigationPanel').show();

                if (window.innerWidth <= 768 && instructionsPanelVisible) {
                    $('#navigationInstructions').show();
                }
            }

        } catch (error) {
            console.error('Error updating map position:', error);
        }
    }

    function updateStatistics(position) {
        const speedKmh = (position.speed || 0) * 3.6;
        $('#currentSpeed').text(`${speedKmh.toFixed(1)} km/h`);
        $('#traveledDistance').text(`${traveledDistance.toFixed(1)} km`);
    }

    function calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLng / 2) * Math.sin(dLng / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    function centerOnRoute() {
        if (routeLayer && map) {
            map.fitBounds(routeLayer.getBounds(), { padding: [20, 20] });
        }
    }

    function centerOnPosition() {
        if (lastPosition && map) {
            map.setView([lastPosition.lat, lastPosition.lng], 16);
        }
    }

    function toggleMapType() {
        const types = ['street', 'satellite', 'terrain'];
        const currentIndex = types.indexOf(currentMapType);
        currentMapType = types[(currentIndex + 1) % types.length];

        updateMapLayer();

        const icons = {
            'street': 'fas fa-road',
            'satellite': 'fas fa-satellite',
            'terrain': 'fas fa-mountain'
        };

        $('#mapTypeBtn i').removeClass().addClass(icons[currentMapType]);
        showNavigationToast(`Vista cambiada: ${currentMapType}`, 'info');
    }

    function sendPositionUpdate(position) {
        if (!gpsActive) return;

        const data = {
            position: {
                lat: position.lat,
                lng: position.lng,
                accuracy: position.accuracy,
                speed: position.speed,
                heading: position.heading,
                timestamp: position.timestamp.toISOString()
            }
        };

        makeRequest('/driver/update_route_progress/{{ completion.id }}', data,
            function (response) {
                console.log('Position sent successfully');
            },
            function (error) {
                console.error('Error sending position:', error);
            }
        );
    }

    function pauseNavigation() {
        if (gpsActive) {
            stopGPS();
            showNavigationToast('Navegación pausada', 'info');
        } else {
            showNavigationToast('La navegación ya está pausada', 'warning');
        }
    }

    function updateTripSummary() {
        const now = new Date();
        const totalTime = Math.floor((now - startTime) / 1000);
        const hours = Math.floor(totalTime / 3600);
        const minutes = Math.floor((totalTime % 3600) / 60);

        $('#summaryTime').text(`${hours}h ${minutes}m`);
        $('#summaryDistance').text(`${traveledDistance.toFixed(1)} km`);

        const avgSpeed = totalTime > 0 ? (traveledDistance / (totalTime / 3600)) : 0;
        $('#summarySpeed').text(`${avgSpeed.toFixed(1)} km/h`);

        $('#tripSummary').show();
    }

    function completeRoute() {
        const fuelLevel = $('input[name="fuel_end_level"]:checked').val();
        const notes = $('#completion_notes').val().trim();

        if (!fuelLevel) {
            showNavigationToast('Selecciona el nivel de combustible', 'warning');
            return;
        }

        if (!confirm(`¿Completar ruta con combustible ${fuelLevel}/4?`)) {
            return;
        }

        const button = $('#completeRouteBtn');
        const originalText = button.html();
        button.html('<span class="spinner-border spinner-border-sm me-2"></span>Completando...').prop('disabled', true);

        const requestData = {
            fuel_level: parseInt(fuelLevel),
            notes: notes,
            final_position: lastPosition,
            trip_summary: {
                total_time: Math.floor((new Date() - startTime) / 1000),
                traveled_distance: traveledDistance,
                tracking_points: trackingPoints
            }
        };

        makeRequest('/driver/complete_route/{{ completion.id }}', requestData,
            function (response) {
                if (gpsActive) stopGPS();

                if (elapsedInterval) {
                    clearInterval(elapsedInterval);
                }

                showNavigationToast(response.message || 'Ruta completada exitosamente', 'success');
                $('#completeModal').modal('hide');

                setTimeout(() => {
                    window.location.href = '/driver/dashboard';
                }, 2000);
            },
            function (errorMessage) {
                showNavigationToast(errorMessage, 'error');
                button.html(originalText).prop('disabled', false);
            }
        );
    }

    function cancelRoute(completionId) {
        const reason = prompt('¿Por qué cancelas la ruta?');

        if (reason !== null && reason.trim() !== '') {
            if (gpsActive) stopGPS();

            if (elapsedInterval) {
                clearInterval(elapsedInterval);
            }

            const requestData = {
                reason: reason.trim(),
                final_position: lastPosition,
                trip_summary: {
                    total_time: Math.floor((new Date() - startTime) / 1000),
                    traveled_distance: traveledDistance,
                    tracking_points: trackingPoints
                }
            };

            makeRequest(`/driver/cancel_route/${completionId}`, requestData,
                function (response) {
                    showNavigationToast(response.message || 'Ruta cancelada', 'success');
                    setTimeout(() => {
                        window.location.href = '/driver/dashboard';
                    }, 2000);
                },
                function (errorMessage) {
                    showNavigationToast(errorMessage, 'error');
                }
            );
        }
    }

    function makeRequest(url, data, successCallback, errorCallback) {
        $.ajax({
            url: url,
            method: 'POST',
            data: JSON.stringify(data),
            contentType: 'application/json',
            timeout: 15000,
            beforeSend: function (xhr) {
                xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            },
            success: function (response) {
                if (typeof successCallback === 'function') {
                    successCallback(response);
                }
            },
            error: function (xhr, status, error) {
                console.error('AJAX Error:', {
                    url: url,
                    status: xhr.status,
                    statusText: xhr.statusText,
                    error: error,
                    response: xhr.responseText
                });

                let errorMessage = 'Error de conexión';

                if (xhr.status === 0) {
                    errorMessage = 'Sin conexión a internet';
                } else if (xhr.status === 404) {
                    errorMessage = 'Recurso no encontrado';
                } else if (xhr.status === 500) {
                    errorMessage = 'Error del servidor';
                } else if (status === 'timeout') {
                    errorMessage = 'Tiempo de espera agotado';
                } else {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        errorMessage = response.error || response.message || errorMessage;
                    } catch (e) {
                        // Usar mensaje por defecto
                    }
                }

                if (typeof errorCallback === 'function') {
                    errorCallback(errorMessage);
                }
            }
        });
    }

    function handleVisibilityChange() {
        if (document.hidden) {
            console.log('Page hidden, reducing GPS frequency');
        } else {
            console.log('Page visible, resuming normal GPS updates');
            if (map) {
                map.invalidateSize();
            }
        }
    }

    function handleConnectionChange() {
        const isOnline = navigator.onLine;
        const connectionStatus = $('#connectionStatus');

        if (isOnline) {
            connectionStatus.hide();
        } else {
            connectionStatus.show();
        }
    }

    // Limpiar recursos al salir
    window.addEventListener('beforeunload', function () {
        if (gpsActive) {
            stopGPS();
        }
        if (elapsedInterval) {
            clearInterval(elapsedInterval);
        }
        if (speechSynthesis) {
            speechSynthesis.cancel();
        }
    });

    // Función de utilidad para detectar dispositivo móvil
    function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    // Aplicar configuraciones específicas para móvil
    if (isMobileDevice()) {
        console.log('Mobile device detected, applying mobile optimizations');

        $(document).ready(function () {
            $('input, textarea, select').on('focus', function () {
                $('meta[name=viewport]').attr('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0');
            }).on('blur', function () {
                $('meta[name=viewport]').attr('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
            });

            $('#navigationMap').css('height', '55vh');
            $('body').addClass('mobile-device');
        });
    }

    // Debug para identificar problemas de carga
    console.log('=== ENHANCED NAVIGATION DEBUG INFO ===');
    console.log('Route ID:', {{ route.id }});
    console.log('Route name:', '{{ route.name }}');
    console.log('Completion ID:', {{ completion.id }});
    console.log('Started at:', '{{ completion.started_at.isoformat() }}');
    console.log('Vehicle:', '{{ completion.vehicle.plate_number if completion.vehicle else "N/A" }}');
    console.log('Speech synthesis support:', 'speechSynthesis' in window);
    console.log('Geolocation support:', 'geolocation' in navigator);
    console.log('Online status:', navigator.onLine);
    console.log('Screen size:', window.screen.width + 'x' + window.screen.height);
    console.log('======================================');
</script>
{% endblock %}
