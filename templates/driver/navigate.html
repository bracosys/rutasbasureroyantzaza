{% extends "base.html" %}

{% block title %}Navegando: {{ route.name }} - Sistema de Optimizaci√≥n de Rutas{% endblock %}

{% block page_title %}Navegando: {{ route.name }}{% endblock %}

{% block meta_tags %}
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
{% endblock %}

{% block sidebar_items %}
<li class="nav-item">
    <a href="{{ url_for('driver_dashboard') }}" class="nav-link">
        <i class="fas fa-tachometer-alt me-2"></i> Dashboard
    </a>
</li>
<li class="nav-item">
    <a href="{{ url_for('driver_route_history') }}" class="nav-link">
        <i class="fas fa-history me-2"></i> Historial de rutas
    </a>
</li>
{% endblock %}

{% block content %}
<!-- Header de navegaci√≥n inteligente -->
<div class="navigation-header">
    <div class="route-info">
        <h1 class="route-title">
            <i class="fas fa-route me-2"></i>
            {{ route.name }}
        </h1>
        <div class="navigation-controls">
            <span class="status-indicator status-gps-inactive" id="gpsStatusIndicator">
                <i class="fas fa-satellite-dish"></i>
                GPS Inactivo
            </span>
            <button class="btn btn-outline-primary btn-sm" onclick="toggleSidePanel()">
                <i class="fas fa-cog"></i>
            </button>
        </div>
    </div>
</div>

<!-- Mapa principal mejorado -->
<div class="map-container">
    <div id="navigationMap"></div>

    <!-- Overlay de informaci√≥n inteligente -->
    <div class="smart-overlay" id="smartOverlay">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0 fw-bold">Estado de Navegaci√≥n</h6>
            <button class="btn btn-sm btn-outline-secondary minimize-btn" onclick="toggleOverlay()">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        <div class="overlay-content">
            <div class="mb-2">
                <small class="text-muted">Tiempo transcurrido</small>
                <div class="fw-bold" id="elapsedTime">00:00:00</div>
            </div>
            <div class="mb-2">
                <small class="text-muted">Posici√≥n actual</small>
                <div class="small" id="currentPosition">Buscando GPS...</div>
            </div>
            <div class="mb-2">
                <small class="text-muted">Precisi√≥n GPS</small>
                <div class="small" id="gpsAccuracy">N/A</div>
            </div>
            <div class="mb-2">
                <small class="text-muted">Distancia recorrida</small>
                <div class="fw-bold" id="traveledDistance">0.0 km</div>
            </div>
            <div class="speed-display text-center">
                <span id="currentSpeed">0</span> km/h
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="routeProgress"></div>
            </div>
        </div>
    </div>

    <!-- Panel de navegaci√≥n turn-by-turn -->
    <div class="turn-panel" id="turnPanel">
        <div class="turn-instruction">
            <div class="turn-icon" id="turnIcon">
                <i class="fas fa-arrow-up"></i>
            </div>
            <div class="turn-details">
                <h4 id="turnInstruction">Contin√∫a recto</h4>
                <p class="turn-distance" id="turnDistance">Mant√©n el rumbo actual</p>
            </div>
        </div>
    </div>

    <!-- Controles de mapa flotantes -->
    <div class="map-controls">
        <button class="map-control-btn" onclick="centerOnPosition()" title="Mi ubicaci√≥n" id="centerBtn">
            <i class="fas fa-location-arrow"></i>
        </button>
        <button class="map-control-btn" onclick="centerOnRoute()" title="Ver ruta completa">
            <i class="fas fa-route"></i>
        </button>
        <button class="map-control-btn" onclick="toggleMapType()" title="Cambiar vista" id="mapTypeBtn">
            <i class="fas fa-layer-group"></i>
        </button>
        <button class="map-control-btn" onclick="toggleTraffic()" title="Tr√°fico" id="trafficBtn">
            <i class="fas fa-car"></i>
        </button>
    </div>

    <!-- Bot√≥n de acci√≥n flotante inteligente -->
    <div class="fab-container">
        <button class="fab" id="mainActionBtn" onclick="toggleGPS()">
            <i class="fas fa-play"></i>
        </button>
    </div>
</div>

<!-- Panel lateral mejorado -->
<div class="side-panel" id="sidePanel">
    <div class="panel-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Control de Navegaci√≥n</h5>
            <button class="btn btn-sm btn-outline-light" onclick="toggleSidePanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    <div class="panel-content">
        <!-- Informaci√≥n de la ruta -->
        <div class="mb-4">
            <h6 class="fw-bold text-primary">
                <i class="fas fa-route me-2"></i>Informaci√≥n de Ruta
            </h6>
            <div class="bg-light p-3 rounded">
                <strong>{{ route.name }}</strong><br>
                {% if route.distance %}
                <span class="text-muted">Distancia: {{ route.distance|distance_format }}</span><br>
                {% endif %}
                <span class="text-muted">Iniciada: {{ completion.started_at|datetime_format }}</span>
            </div>
        </div>

        <!-- Informaci√≥n del veh√≠culo -->
        <div class="mb-4">
            <h6 class="fw-bold text-primary">
                <i class="fas fa-car me-2"></i>Veh√≠culo Asignado
            </h6>
            <div class="bg-light p-3 rounded">
                <strong>{{ completion.vehicle.brand }} {{ completion.vehicle.model }}</strong><br>
                <span class="text-muted">Placa: {{ completion.vehicle.plate_number }}</span>
            </div>
        </div>

        <!-- Estado de combustible inteligente -->
        <div class="mb-4">
            <h6 class="fw-bold text-primary">
                <i class="fas fa-gas-pump me-2"></i>Estado de Combustible
            </h6>
            <div class="bg-light p-3 rounded">
                <div class="d-flex justify-content-between align-items-center">
                    <span>Inicial:</span>
                    <span class="badge bg-success">{{ completion.fuel_start }}/4</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <span>Estimado actual:</span>
                    <span class="badge bg-warning" id="currentFuelEstimate">{{ completion.fuel_start }}/4</span>
                </div>
            </div>
        </div>

        <!-- Estad√≠sticas en tiempo real -->
        <div class="mb-4">
            <h6 class="fw-bold text-primary">
                <i class="fas fa-chart-line me-2"></i>Estad√≠sticas del Viaje
            </h6>
            <div class="row g-2">
                <div class="col-6">
                    <div class="bg-light p-2 rounded text-center">
                        <small class="text-muted">Vel. Prom.</small>
                        <div class="fw-bold" id="averageSpeed">0 km/h</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="bg-light p-2 rounded text-center">
                        <small class="text-muted">Puntos GPS</small>
                        <div class="fw-bold" id="gpsPointsCount">0</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="bg-light p-2 rounded text-center">
                        <small class="text-muted">Paradas</small>
                        <div class="fw-bold" id="stopsCount">0</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="bg-light p-2 rounded text-center">
                        <small class="text-muted">Eficiencia</small>
                        <div class="fw-bold" id="routeEfficiency">100%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controles principales -->
        <div class="d-grid gap-2">
            <button class="btn btn-success btn-lg" onclick="completeRoute()">
                <i class="fas fa-flag-checkered me-2"></i>Completar Ruta
            </button>
            <button class="btn btn-warning" onclick="pauseNavigation()">
                <i class="fas fa-pause me-2"></i>Pausar
            </button>
            <button class="btn btn-outline-danger" onclick="cancelRoute()">
                <i class="fas fa-times me-2"></i>Cancelar Ruta
            </button>
        </div>

        <!-- Informaci√≥n de optimizaci√≥n -->
        <div class="mt-4 p-3 bg-info bg-opacity-10 rounded">
            <small class="text-muted">
                <i class="fas fa-brain me-1"></i>
                Sistema inteligente activado: optimizaci√≥n autom√°tica de bater√≠a y precisi√≥n GPS.
            </small>
        </div>

        <!-- Estado de conectividad -->
        <div class="mt-3" id="connectivityStatus">
            <div class="d-flex align-items-center text-success">
                <i class="fas fa-wifi me-2"></i>
                <small>Conexi√≥n estable</small>
            </div>
        </div>
    </div>
</div>

<!-- Modal de completar ruta mejorado -->
<div class="modal fade" id="completeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-flag-checkered me-2"></i>Completar Ruta: {{ route.name }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Resumen autom√°tico del viaje -->
                <div class="alert alert-success" id="tripSummaryAlert">
                    <h6 class="mb-2">Resumen del Viaje</h6>
                    <div class="row">
                        <div class="col-4 text-center">
                            <strong id="tripTime">--:--</strong><br>
                            <small>Tiempo</small>
                        </div>
                        <div class="col-4 text-center">
                            <strong id="tripDistance">-- km</strong><br>
                            <small>Distancia</small>
                        </div>
                        <div class="col-4 text-center">
                            <strong id="tripAvgSpeed">-- km/h</strong><br>
                            <small>Vel. Prom.</small>
                        </div>
                    </div>
                </div>

                <!-- Selector de combustible inteligente -->
                <div class="fuel-selector">
                    <h6 class="mb-3">Nivel Final de Combustible</h6>
                    <div class="fuel-options">
                        <div class="fuel-option">
                            <input type="radio" id="fuel1" name="fuelLevel" value="1">
                            <div class="fuel-gauge fuel-1">
                                <div class="fuel-fill"></div>
                            </div>
                            <div class="fuel-label">1/4</div>
                        </div>
                        <div class="fuel-option">
                            <input type="radio" id="fuel2" name="fuelLevel" value="2">
                            <div class="fuel-gauge fuel-2">
                                <div class="fuel-fill"></div>
                            </div>
                            <div class="fuel-label">2/4</div>
                        </div>
                        <div class="fuel-option">
                            <input type="radio" id="fuel3" name="fuelLevel" value="3" checked>
                            <div class="fuel-gauge fuel-3">
                                <div class="fuel-fill"></div>
                            </div>
                            <div class="fuel-label">3/4</div>
                        </div>
                        <div class="fuel-option">
                            <input type="radio" id="fuel4" name="fuelLevel" value="4">
                            <div class="fuel-gauge fuel-4">
                                <div class="fuel-fill"></div>
                            </div>
                            <div class="fuel-label">4/4</div>
                        </div>
                    </div>
                </div>

                <!-- Notas del recorrido -->
                <div class="mb-3">
                    <label class="form-label">Notas del recorrido (opcional)</label>
                    <textarea class="form-control" id="completionNotes" rows="3"
                        placeholder="Observaciones sobre el recorrido, incidentes, condiciones de la ruta, etc."></textarea>
                </div>

                <!-- An√°lisis autom√°tico (se llenar√° din√°micamente) -->
                <div id="analysisContainer" style="display: none;">
                    <div class="alert alert-info">
                        <h6>An√°lisis Inteligente del Recorrido</h6>
                        <div id="analysisContent"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="completeRouteBtn" onclick="completeRouteAdvanced()">
                    <i class="fas fa-flag-checkered me-2"></i>Completar Ruta
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Notificaci√≥n toast inteligente -->
<div class="notification-toast" id="notificationToast">
    <div class="d-flex align-items-center">
        <i class="fas fa-info-circle me-2" id="toastIcon"></i>
        <span id="toastMessage">Mensaje de notificaci√≥n</span>
    </div>
</div>

<!-- Indicador de conexi√≥n -->
<div class="connection-indicator" id="connectionIndicator" style="display: none;">
    <i class="fas fa-wifi-slash mb-2" style="font-size: 2rem;"></i><br>
    <strong>Sin conexi√≥n a internet</strong><br>
    <small>Los datos se sincronizar√°n cuando se restablezca la conexi√≥n</small>
</div>

<!-- Loading overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="loading-spinner-large"></div>
        <h5>Inicializando navegaci√≥n inteligente...</h5>
        <p class="text-muted">Cargando mapa y configurando GPS</p>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
    :root {
        --primary-color: #007bff;
        --success-color: #28a745;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
        --dark-color: #343a40;
        --light-color: #f8f9fa;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        margin: 0;
        padding: 0;
    }

    /* Header de navegaci√≥n fijo */
    .navigation-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1050;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        padding: 0.75rem 1rem;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
    }

    .route-info {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .route-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--dark-color);
        margin: 0;
    }

    .navigation-controls {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    /* Panel lateral inteligente */
    .side-panel {
        position: fixed;
        top: 80px;
        right: -320px;
        width: 320px;
        height: calc(100vh - 80px);
        background: white;
        box-shadow: -5px 0 25px rgba(0, 0, 0, 0.15);
        transition: right 0.3s ease;
        z-index: 1040;
        overflow-y: auto;
        border-radius: 15px 0 0 0;
    }

    .side-panel.open {
        right: 0;
    }

    .panel-header {
        background: var(--primary-color);
        color: white;
        padding: 1rem;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .panel-content {
        padding: 1rem;
    }

    /* Mapa principal mejorado */
    .map-container {
        position: fixed;
        top: 80px;
        left: 0;
        right: 0;
        bottom: 0;
        background: #f0f0f0;
    }

    #navigationMap {
        width: 100%;
        height: 100%;
        position: relative;
    }

    /* Overlay de informaci√≥n inteligente */
    .smart-overlay {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 1rem;
        max-width: 280px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        transition: all 0.3s ease;
    }

    .smart-overlay.minimized {
        max-width: 60px;
        padding: 0.75rem;
        cursor: pointer;
    }

    .smart-overlay.minimized .overlay-content {
        display: none;
    }

    .smart-overlay.minimized .minimize-btn {
        transform: rotate(180deg);
    }

    /* Panel de navegaci√≥n turn-by-turn */
    .turn-panel {
        position: absolute;
        bottom: 100px;
        left: 20px;
        right: 20px;
        background: linear-gradient(135deg, var(--primary-color), #0056b3);
        color: white;
        border-radius: 15px;
        padding: 1.25rem;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        display: none;
        animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
        from {
            transform: translateY(100%);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .turn-instruction {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .turn-icon {
        font-size: 2.5rem;
        min-width: 50px;
        text-align: center;
    }

    .turn-details h4 {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 600;
    }

    .turn-distance {
        font-size: 0.9rem;
        opacity: 0.9;
        margin: 0;
    }

    /* Bot√≥n de acci√≥n flotante */
    .fab-container {
        position: absolute;
        bottom: 20px;
        right: 20px;
        z-index: 1001;
    }

    .fab {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--success-color);
        color: white;
        border: none;
        box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .fab:hover {
        transform: scale(1.1);
        box-shadow: 0 12px 30px rgba(40, 167, 69, 0.4);
    }

    .fab.danger {
        background: var(--danger-color);
        box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
    }

    /* Indicadores de estado */
    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .status-gps-active {
        background: rgba(40, 167, 69, 0.1);
        color: var(--success-color);
        animation: pulse 2s infinite;
    }

    .status-gps-inactive {
        background: rgba(108, 117, 125, 0.1);
        color: #6c757d;
    }

    .status-gps-error {
        background: rgba(220, 53, 69, 0.1);
        color: var(--danger-color);
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }
    }

    /* Selector de combustible mejorado */
    .fuel-selector {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 1rem;
        margin: 1rem 0;
    }

    .fuel-options {
        display: flex;
        gap: 0.75rem;
        justify-content: space-between;
    }

    .fuel-option {
        flex: 1;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .fuel-option input[type="radio"] {
        display: none;
    }

    .fuel-gauge {
        width: 100%;
        height: 60px;
        background: #e9ecef;
        border: 2px solid #dee2e6;
        border-radius: 30px;
        position: relative;
        overflow: hidden;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }

    .fuel-fill {
        position: absolute;
        bottom: 0;
        width: 100%;
        transition: all 0.3s ease;
        border-radius: 0 0 28px 28px;
    }

    .fuel-1 .fuel-fill {
        height: 25%;
        background: linear-gradient(180deg, #dc3545, #c82333);
    }

    .fuel-2 .fuel-fill {
        height: 50%;
        background: linear-gradient(180deg, #fd7e14, #e8670e);
    }

    .fuel-3 .fuel-fill {
        height: 75%;
        background: linear-gradient(180deg, #ffc107, #e0a800);
    }

    .fuel-4 .fuel-fill {
        height: 100%;
        background: linear-gradient(180deg, #28a745, #1e7e34);
        border-radius: 28px;
    }

    .fuel-option:hover .fuel-gauge {
        transform: scale(1.05);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .fuel-option input:checked+.fuel-gauge {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        transform: scale(1.1);
    }

    .fuel-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #6c757d;
        transition: color 0.3s ease;
    }

    .fuel-option input:checked+.fuel-gauge+.fuel-label {
        color: var(--primary-color);
    }

    /* Controles de mapa flotantes */
    .map-controls {
        position: absolute;
        bottom: 180px;
        left: 20px;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        z-index: 1000;
    }

    .map-control-btn {
        width: 45px;
        height: 45px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--dark-color);
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .map-control-btn:hover {
        background: white;
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    .map-control-btn.active {
        background: var(--primary-color);
        color: white;
    }

    /* Notificaciones mejoradas */
    .notification-toast {
        position: fixed;
        top: 100px;
        right: 20px;
        background: white;
        border-radius: 15px;
        padding: 1rem 1.25rem;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        z-index: 1060;
        transform: translateX(400px);
        transition: transform 0.3s ease;
        max-width: 320px;
    }

    .notification-toast.show {
        transform: translateX(0);
    }

    .notification-toast.success {
        border-left: 4px solid var(--success-color);
    }

    .notification-toast.error {
        border-left: 4px solid var(--danger-color);
    }

    .notification-toast.warning {
        border-left: 4px solid var(--warning-color);
    }

    .notification-toast.info {
        border-left: 4px solid var(--primary-color);
    }

    .speed-display {
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-weight: 600;
        margin-top: 0.5rem;
    }

    .progress-bar-container {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        height: 8px;
        margin: 0.5rem 0;
        overflow: hidden;
    }

    .progress-bar {
        background: var(--success-color);
        height: 100%;
        border-radius: 10px;
        transition: width 0.3s ease;
        width: 0%;
    }

    /* Indicador de conexi√≥n */
    .connection-indicator {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(220, 53, 69, 0.95);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 15px;
        z-index: 2000;
        text-align: center;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    /* Animaciones de carga */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: opacity 0.3s ease;
    }

    .loading-overlay.hidden {
        opacity: 0;
        pointer-events: none;
    }

    .loading-content {
        text-align: center;
        padding: 2rem;
    }

    .loading-spinner-large {
        width: 60px;
        height: 60px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Marcadores personalizados */
    .custom-marker {
        background: white;
        border-radius: 50%;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .custom-position-marker {
        background: #007bff;
        border: 3px solid white;
        border-radius: 50%;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        animation: pulse-position 2s infinite;
    }

    @keyframes pulse-position {
        0% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.2);
        }

        100% {
            transform: scale(1);
        }
    }

    .route-marker {
        background: white;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    /* Responsive design mejorado */
    @media (max-width: 768px) {
        .navigation-header {
            padding: 0.5rem;
        }

        .route-info {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem;
        }

        .navigation-controls {
            align-self: flex-end;
        }

        .side-panel {
            width: 100%;
            right: -100%;
        }

        .smart-overlay {
            max-width: calc(100vw - 40px);
            left: 10px;
            right: 10px;
            top: 10px;
        }

        .turn-panel {
            left: 10px;
            right: 10px;
            bottom: 80px;
        }

        .map-controls {
            bottom: 160px;
            left: 10px;
        }

        .fab-container {
            bottom: 10px;
            right: 10px;
        }

        .notification-toast {
            right: 10px;
            left: 10px;
            max-width: none;
        }
    }

    /* Mejoras para dispositivos t√°ctiles */
    @media (hover: none) and (pointer: coarse) {

        .btn,
        .fab,
        .map-control-btn {
            min-height: 44px;
            min-width: 44px;
        }

        .fuel-option {
            padding: 0.75rem;
        }

        .navigation-controls button {
            padding: 0.5rem 0.75rem;
        }
    }

    /* Optimizaciones para pantallas peque√±as */
    @media (max-width: 480px) {
        .smart-overlay {
            max-width: calc(100vw - 20px);
            left: 10px;
            right: 10px;
        }

        .turn-panel {
            left: 10px;
            right: 10px;
            padding: 1rem;
        }

        .turn-icon {
            font-size: 2rem;
            min-width: 40px;
        }

        .fuel-options {
            gap: 0.5rem;
        }

        .fuel-gauge {
            height: 50px;
        }
    }

    /* Tema oscuro */
    .dark-theme {
        --primary-color: #4dabf7;
        --success-color: #51cf66;
        --warning-color: #ffd43b;
        --danger-color: #ff6b6b;
        --dark-color: #f8f9fa;
        --light-color: #212529;
    }

    .dark-theme body {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    }

    .dark-theme .navigation-header {
        background: rgba(33, 37, 41, 0.95);
    }

    .dark-theme .route-title {
        color: var(--dark-color);
    }

    .dark-theme .side-panel {
        background: #343a40;
        color: #f8f9fa;
    }

    .dark-theme .smart-overlay {
        background: rgba(33, 37, 41, 0.95);
        color: #f8f9fa;
    }

    .dark-theme .notification-toast {
        background: #343a40;
        color: #f8f9fa;
    }

    .dark-theme .modal-content {
        background: #343a40;
        color: #f8f9fa;
    }

    .dark-theme .bg-light {
        background: #495057 !important;
        color: #f8f9fa;
    }

    .dark-theme .fuel-selector {
        background: #495057;
    }

    /* Animaciones adicionales */
    .bounce-in {
        animation: bounceIn 0.6s ease;
    }

    @keyframes bounceIn {
        0% {
            transform: scale(0.3);
            opacity: 0;
        }

        50% {
            transform: scale(1.05);
        }

        70% {
            transform: scale(0.9);
        }

        100% {
            transform: scale(1);
            opacity: 1;
        }
    }

    .fade-in {
        animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Estados de carga */
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // Variables globales del sistema de navegaci√≥n inteligente
    let map = null;
    let gpsActive = false;
    let currentPosition = null;
    let routeProgress = 0;
    let startTime = new Date('{{ completion.started_at.isoformat() }}');
    let traveledDistance = 0;
    let speedHistory = [];
    let isOverlayMinimized = false;
    let gpsWatchId = null;
    let mapType = 'street';
    let navigationSession = null;
    let lastUpdateTime = 0;
    let batteryLevel = 100;
    let trackingPoints = [];
    let lastPosition = null;
    let stopsCount = 0;
    let gpsPointsCount = 0;

    // Configuraci√≥n avanzada de GPS
    const GPS_CONFIG = {
        enableHighAccuracy: true,
        timeout: 30000,
        maximumAge: 60000,
        minDistance: 5, // metros m√≠nimos para registrar punto
        minTime: 10, // segundos m√≠nimos entre puntos
        batteryOptimization: true
    };

    // Inicializaci√≥n del sistema
    document.addEventListener('DOMContentLoaded', function () {
        console.log('=== INICIANDO SISTEMA DE NAVEGACI√ìN INTELIGENTE ===');
        showLoadingOverlay();

        setTimeout(() => {
            initializeIntelligentNavigation();
            hideLoadingOverlay();
        }, 2000);
    });

    function initializeIntelligentNavigation() {
        try {
            // Inicializar componentes principales
            initializeMap();
            startElapsedTimer();
            checkNetworkStatus();
            requestNotificationPermission();
            monitorBattery();

            // Inicializar sesi√≥n de navegaci√≥n
            initializeNavigationSession();

            // Configurar eventos
            setupEventListeners();

            console.log('‚úÖ Sistema de navegaci√≥n inteligente inicializado');
            showNotification('Sistema de navegaci√≥n listo', 'success');

        } catch (error) {
            console.error('‚ùå Error inicializando navegaci√≥n:', error);
            showNotification('Error inicializando sistema de navegaci√≥n', 'error');
        }
    }

    // Inicializar mapa con mejoras
    function initializeMap() {
        map = L.map('navigationMap', {
            zoomControl: false,
            attributionControl: false
        }).setView([-3.8167, -78.7500], 14);

        updateMapLayer();
        loadRouteData();

        console.log('‚úÖ Mapa inicializado');
    }

    // Actualizar capa del mapa
    function updateMapLayer() {
        map.eachLayer(function (layer) {
            if (layer._url) {
                map.removeLayer(layer);
            }
        });

        let tileUrl, attribution;
        switch (mapType) {
            case 'satellite':
                tileUrl = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
                attribution = '¬© Esri';
                break;
            case 'terrain':
                tileUrl = 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png';
                attribution = '¬© OpenTopoMap';
                break;
            default:
                tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
                attribution = '¬© OpenStreetMap';
        }

        L.tileLayer(tileUrl, {
            maxZoom: 19,
            attribution: attribution
        }).addTo(map);
    }

    // Cargar datos de ruta
    function loadRouteData() {
        fetch('/api/route/navigation-data/{{ route.id }}')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.coordinates) {
                    displayRoute(data.coordinates);
                    console.log(`‚úÖ Ruta cargada: ${data.coordinates.length} puntos`);
                } else {
                    console.warn('‚ö†Ô∏è No se pudieron cargar coordenadas de ruta');
                    loadDemoRoute();
                }
            })
            .catch(error => {
                console.error('‚ùå Error cargando ruta:', error);
                loadDemoRoute();
            });
    }

    // Cargar ruta de demostraci√≥n
    function loadDemoRoute() {
        const routeCoordinates = [
            [-3.8167, -78.7500],
            [-3.8170, -78.7503],
            [-3.8175, -78.7508],
            [-3.8180, -78.7515],
            [-3.8185, -78.7520],
            [-3.8190, -78.7525],
            [-3.8195, -78.7530]
        ];

        displayRoute(routeCoordinates);
        console.log('‚úÖ Ruta de demostraci√≥n cargada');
    }

    // Mostrar ruta en el mapa
    function displayRoute(coordinates) {
        if (!map || !coordinates || coordinates.length === 0) return;

        try {
            // Crear polyline de la ruta
            const routeLine = L.polyline(coordinates, {
                color: '#007bff',
                weight: 5,
                opacity: 0.8
            }).addTo(map);

            // Marcadores de inicio y fin
            L.marker(coordinates[0], {
                icon: L.divIcon({
                    html: '<div class="route-marker"><i class="fas fa-play" style="color: #28a745; font-size: 1.2rem;"></i></div>',
                    className: 'custom-marker',
                    iconSize: [30, 30]
                })
            }).addTo(map).bindPopup('Inicio de ruta');

            L.marker(coordinates[coordinates.length - 1], {
                icon: L.divIcon({
                    html: '<div class="route-marker"><i class="fas fa-flag-checkered" style="color: #dc3545; font-size: 1.2rem;"></i></div>',
                    className: 'custom-marker',
                    iconSize: [30, 30]
                })
            }).addTo(map).bindPopup('Destino');

            // Ajustar vista del mapa
            map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });

        } catch (error) {
            console.error('Error displaying route:', error);
        }
    }

    // Inicializar sesi√≥n de navegaci√≥n
    async function initializeNavigationSession() {
        try {
            const response = await fetch('/api/navigation/start-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    route_id: {{ route.id }},
                vehicle_id: {{ completion.vehicle.id }},
        fuel_level: { { completion.fuel_start } }
    })
            });

    const data = await response.json();

    if (data.success) {
        navigationSession = data;
        console.log('‚úÖ Sesi√≥n de navegaci√≥n inicializada:', data.session_id);
    } else {
        console.warn('‚ö†Ô∏è No se pudo inicializar sesi√≥n:', data.error);
    }
        } catch (error) {
        console.error('‚ùå Error inicializando sesi√≥n:', error);
    }
    }

    // Control de GPS inteligente
    function toggleGPS() {
        if (gpsActive) {
            stopGPS();
        } else {
            startGPS();
        }
    }

    function startGPS() {
        if (!navigator.geolocation) {
            showNotification('Geolocalizaci√≥n no disponible en este dispositivo', 'error');
            return;
        }

        showNotification('Activando GPS inteligente...', 'info');

        gpsWatchId = navigator.geolocation.watchPosition(
            onGPSSuccess,
            onGPSError,
            GPS_CONFIG
        );

        gpsActive = true;
        updateGPSUI();
        console.log('‚úÖ GPS activado con configuraci√≥n inteligente');
    }

    function stopGPS() {
        if (gpsWatchId !== null) {
            navigator.geolocation.clearWatch(gpsWatchId);
            gpsWatchId = null;
        }

        gpsActive = false;
        updateGPSUI();
        showNotification('GPS desactivado', 'warning');
        console.log('‚èπÔ∏è GPS desactivado');
    }

    function onGPSSuccess(position) {
        const coords = position.coords;
        currentPosition = {
            lat: coords.latitude,
            lng: coords.longitude,
            accuracy: coords.accuracy,
            speed: coords.speed || 0,
            heading: coords.heading || 0,
            timestamp: new Date()
        };

        // Actualizar interfaz
        updatePositionDisplay();
        updateMapPosition();
        updateStatistics();
        updateTurnByTurn();

        // Actualizar posici√≥n en servidor (optimizado)
        updatePositionOptimized(position);

        console.log('üìç Posici√≥n GPS actualizada:', currentPosition);
    }

    function onGPSError(error) {
        let errorMessage = 'Error de GPS';
        switch (error.code) {
            case error.PERMISSION_DENIED:
                errorMessage = 'Permiso de ubicaci√≥n denegado. Activa la ubicaci√≥n en configuraci√≥n.';
                break;
            case error.POSITION_UNAVAILABLE:
                errorMessage = 'Ubicaci√≥n no disponible. Verifica tu conexi√≥n.';
                break;
            case error.TIMEOUT:
                errorMessage = 'Tiempo de espera de GPS agotado.';
                break;
        }

        showNotification(errorMessage, 'error');
        updateGPSStatus('error');
        console.error('‚ùå Error GPS:', error);
    }

    // Actualizaci√≥n optimizada de posici√≥n
    async function updatePositionOptimized(position) {
        if (!navigationSession) return;

        const now = Date.now();
        const timeSinceLastUpdate = now - lastUpdateTime;

        // Optimizaci√≥n inteligente basada en movimiento y bater√≠a
        const speed = (position.coords.speed || 0) * 3.6; // km/h
        const isMoving = speed > 5;

        let shouldUpdate = false;

        if (isMoving) {
            // Actualizar m√°s frecuentemente cuando se mueve
            shouldUpdate = timeSinceLastUpdate > (batteryLevel > 20 ? 15000 : 30000);
        } else {
            // Actualizar menos frecuentemente cuando est√° parado
            shouldUpdate = timeSinceLastUpdate > 60000;
        }

        if (!shouldUpdate) return;

        try {
            const response = await fetch('/api/navigation/update-position', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    session_id: navigationSession.session_id,
                    position: {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        speed: position.coords.speed,
                        heading: position.coords.heading,
                        battery_level: batteryLevel
                    }
                })
            });

            const data = await response.json();

            if (data.success) {
                lastUpdateTime = now;
                gpsPointsCount = data.points_recorded || gpsPointsCount;

                // Procesar sugerencias de navegaci√≥n
                if (data.navigation_hints) {
                    processNavigationHints(data.navigation_hints);
                }

                // Mostrar advertencias si hay
                if (data.warning) {
                    showNotification(data.warning.message, 'warning');
                }

                console.log('üì° Posici√≥n enviada al servidor');
            }

        } catch (error) {
            console.error('‚ùå Error actualizando posici√≥n:', error);
        }
    }

    // Procesar sugerencias de navegaci√≥n
    function processNavigationHints(hints) {
        hints.forEach(hint => {
            switch (hint.type) {
                case 'speed_suggestion':
                    updateTurnByTurn('üöó', 'Sugerencia de velocidad', hint.message);
                    break;
                case 'gps_warning':
                    updateTurnByTurn('‚ö†Ô∏è', 'Atenci√≥n GPS', hint.message);
                    break;
                default:
                    console.log('üí° Sugerencia recibida:', hint);
            }
        });
    }

    // Actualizar interfaz de GPS
    function updateGPSUI() {
        const statusIndicator = document.getElementById('gpsStatusIndicator');
        const mainActionBtn = document.getElementById('mainActionBtn');

        if (gpsActive) {
            statusIndicator.className = 'status-indicator status-gps-active';
            statusIndicator.innerHTML = '<i class="fas fa-satellite-dish"></i> GPS Activo';

            mainActionBtn.innerHTML = '<i class="fas fa-stop"></i>';
            mainActionBtn.className = 'fab danger';
            mainActionBtn.title = 'Detener GPS';
        } else {
            statusIndicator.className = 'status-indicator status-gps-inactive';
            statusIndicator.innerHTML = '<i class="fas fa-satellite-dish"></i> GPS Inactivo';

            mainActionBtn.innerHTML = '<i class="fas fa-play"></i>';
            mainActionBtn.className = 'fab';
            mainActionBtn.title = 'Activar GPS';
        }
    }

    function updateGPSStatus(status) {
        const statusIndicator = document.getElementById('gpsStatusIndicator');

        switch (status) {
            case 'active':
                statusIndicator.className = 'status-indicator status-gps-active';
                statusIndicator.innerHTML = '<i class="fas fa-satellite-dish"></i> GPS Activo';
                break;
            case 'error':
                statusIndicator.className = 'status-indicator status-gps-error';
                statusIndicator.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error GPS';
                break;
            default:
                statusIndicator.className = 'status-indicator status-gps-inactive';
                statusIndicator.innerHTML = '<i class="fas fa-satellite-dish"></i> GPS Inactivo';
        }
    }

    // Actualizar visualizaci√≥n de posici√≥n
    function updatePositionDisplay() {
        if (!currentPosition) return;

        const posElement = document.getElementById('currentPosition');
        const accElement = document.getElementById('gpsAccuracy');
        const speedElement = document.getElementById('currentSpeed');

        posElement.innerHTML = `${currentPosition.lat.toFixed(6)}, ${currentPosition.lng.toFixed(6)}`;
        accElement.innerHTML = `¬±${Math.round(currentPosition.accuracy)}m`;

        const speedKmh = (currentPosition.speed || 0) * 3.6;
        speedElement.textContent = Math.round(speedKmh);

        // Actualizar historial de velocidad
        speedHistory.push(speedKmh);
        if (speedHistory.length > 10) {
            speedHistory.shift();
        }

        updateGPSStatus('active');
    }

    // Actualizar posici√≥n en mapa
    function updateMapPosition() {
        if (!currentPosition || !map) return;

        // Remover marcador anterior si existe
        if (window.currentPositionMarker) {
            map.removeLayer(window.currentPositionMarker);
        }

        // Crear nuevo marcador
        window.currentPositionMarker = L.marker([currentPosition.lat, currentPosition.lng], {
            icon: L.divIcon({
                html: '<div class="custom-position-marker"><i class="fas fa-location-arrow"></i></div>',
                className: 'position-marker-container',
                iconSize: [20, 20]
            })
        }).addTo(map);

        // C√≠rculo de precisi√≥n
        if (currentPosition.accuracy < 100) {
            if (window.accuracyCircle) {
                map.removeLayer(window.accuracyCircle);
            }

            window.accuracyCircle = L.circle([currentPosition.lat, currentPosition.lng], {
                radius: currentPosition.accuracy,
                color: '#007bff',
                fillColor: '#007bff',
                fillOpacity: 0.1,
                weight: 1
            }).addTo(map);
        }
    }

    // Actualizar estad√≠sticas
    function updateStatistics() {
        if (!currentPosition) return;

        // Calcular distancia recorrida
        if (lastPosition) {
            const distance = calculateDistance(
                lastPosition.lat, lastPosition.lng,
                currentPosition.lat, currentPosition.lng
            );

            if (distance < 0.1) { // Solo agregar distancias razonables
                traveledDistance += distance;
            }
        }

        lastPosition = { ...currentPosition };

        // Actualizar elementos de interfaz
        document.getElementById('traveledDistance').textContent = `${traveledDistance.toFixed(1)} km`;
        document.getElementById('gpsPointsCount').textContent = gpsPointsCount;

        // Velocidad promedio
        if (speedHistory.length > 0) {
            const avgSpeed = speedHistory.reduce((a, b) => a + b, 0) / speedHistory.length;
            document.getElementById('averageSpeed').textContent = `${Math.round(avgSpeed)} km/h`;
        }

        // Progreso de ruta (estimado)
        const estimatedDistance = {{ route.distance / 1000 if route.distance else 12.8
    }};
    routeProgress = Math.min(100, (traveledDistance / estimatedDistance) * 100);
    document.getElementById('routeProgress').style.width = `${routeProgress}%`;

    // Estimaci√≥n de combustible
    const fuelEstimate = Math.max(1, {{ completion.fuel_start }} - Math.floor(traveledDistance / 3.2));
    document.getElementById('currentFuelEstimate').textContent = `${fuelEstimate}/4`;
    document.getElementById('currentFuelEstimate').className =
        `badge ${fuelEstimate > 2 ? 'bg-success' : fuelEstimate > 1 ? 'bg-warning' : 'bg-danger'}`;

    // Eficiencia de ruta
    const efficiency = Math.min(100, (estimatedDistance / Math.max(traveledDistance, 0.1)) * 100);
    document.getElementById('routeEfficiency').textContent = `${Math.round(efficiency)}%`;
    }

    // Actualizar navegaci√≥n turn-by-turn
    function updateTurnByTurn(icon = null, instruction = null, distance = null) {
        if (!currentPosition) return;

        const turnPanel = document.getElementById('turnPanel');
        const turnIcon = document.getElementById('turnIcon');
        const turnInstruction = document.getElementById('turnInstruction');
        const turnDistance = document.getElementById('turnDistance');

        // Mostrar panel si GPS est√° activo
        if (gpsActive) {
            turnPanel.style.display = 'block';

            const speed = (currentPosition.speed || 0) * 3.6;

            if (icon && instruction) {
                // Usar sugerencia proporcionada
                turnIcon.innerHTML = icon;
                turnInstruction.textContent = instruction;
                turnDistance.textContent = distance || `${Math.round(speed)} km/h`;
            } else if (speed > 5) {
                turnIcon.innerHTML = '<i class="fas fa-arrow-up"></i>';
                turnInstruction.textContent = 'Contin√∫a recto';
                turnDistance.textContent = `${Math.round(speed)} km/h - Siguiente: 200m`;
            } else {
                turnIcon.innerHTML = '<i class="fas fa-pause"></i>';
                turnInstruction.textContent = 'Veh√≠culo detenido';
                turnDistance.textContent = 'Esperando movimiento...';
            }
        } else {
            turnPanel.style.display = 'none';
        }
    }

    // Funciones de utilidad
    function calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371; // Radio de la Tierra en km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLng / 2) * Math.sin(dLng / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    function startElapsedTimer() {
        setInterval(() => {
            const now = new Date();
            const elapsed = Math.floor((now - startTime) / 1000);
            const hours = Math.floor(elapsed / 3600);
            const minutes = Math.floor((elapsed % 3600) / 60);
            const seconds = elapsed % 60;

            document.getElementById('elapsedTime').textContent =
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }, 1000);
    }

    // Controles de interfaz
    function toggleSidePanel() {
        const panel = document.getElementById('sidePanel');
        panel.classList.toggle('open');
    }

    function toggleOverlay() {
        const overlay = document.getElementById('smartOverlay');
        isOverlayMinimized = !isOverlayMinimized;
        overlay.classList.toggle('minimized', isOverlayMinimized);
    }

    function centerOnPosition() {
        if (currentPosition && map) {
            map.setView([currentPosition.lat, currentPosition.lng], 16);
            showNotification('Centrado en tu ubicaci√≥n', 'success');
        } else {
            showNotification('Ubicaci√≥n no disponible', 'warning');
        }
    }

    function centerOnRoute() {
        map.setView([-3.8177, -78.7515], 14);
        showNotification('Vista centrada en la ruta', 'info');
    }

    function toggleMapType() {
        const types = ['street', 'satellite', 'terrain'];
        const currentIndex = types.indexOf(mapType);
        mapType = types[(currentIndex + 1) % types.length];

        updateMapLayer();

        const typeNames = { street: 'Calles', satellite: 'Sat√©lite', terrain: 'Terreno' };
        showNotification(`Vista cambiada: ${typeNames[mapType]}`, 'info');
    }

    function toggleTraffic() {
        const trafficBtn = document.getElementById('trafficBtn');
        trafficBtn.classList.toggle('active');

        if (trafficBtn.classList.contains('active')) {
            showNotification('Informaci√≥n de tr√°fico activada', 'success');
        } else {
            showNotification('Informaci√≥n de tr√°fico desactivada', 'info');
        }
    }

    // Funciones de control de ruta
    function completeRoute() {
        const modal = new bootstrap.Modal(document.getElementById('completeModal'));

        // Actualizar datos del modal
        const elapsed = Math.floor((new Date() - startTime) / 1000);
        const hours = Math.floor(elapsed / 3600);
        const minutes = Math.floor((elapsed % 3600) / 60);

        document.getElementById('tripTime').textContent = `${hours}h ${minutes}m`;
        document.getElementById('tripDistance').textContent = `${traveledDistance.toFixed(1)} km`;

        if (speedHistory.length > 0) {
            const avgSpeed = speedHistory.reduce((a, b) => a + b, 0) / speedHistory.length;
            document.getElementById('tripAvgSpeed').textContent = `${avgSpeed.toFixed(1)} km/h`;
        }

        modal.show();
    }

    // Funci√≥n mejorada para completar ruta
    async function completeRouteAdvanced() {
        if (!navigationSession) {
            showNotification('No hay sesi√≥n de navegaci√≥n activa', 'error');
            return;
        }

        const fuelLevel = document.querySelector('input[name="fuelLevel"]:checked')?.value;
        const notes = document.getElementById('completionNotes').value;

        if (!fuelLevel) {
            showNotification('Selecciona el nivel de combustible', 'warning');
            return;
        }

        // Deshabilitar bot√≥n y mostrar loading
        const btn = document.getElementById('completeRouteBtn');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<span class="loading-spinner me-2"></span>Completando...';
        btn.disabled = true;

        try {
            const response = await fetch('/api/navigation/smart-complete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    session_id: navigationSession.session_id,
                    fuel_level: parseInt(fuelLevel),
                    notes: notes
                })
            });

            const data = await response.json();

            if (data.success) {
                showNotification('Ruta completada con an√°lisis inteligente', 'success');

                // Mostrar resumen del an√°lisis
                if (data.analysis) {
                    showCompletionSummary(data.analysis);
                }

                // Detener GPS
                if (gpsActive) stopGPS();

                // Limpiar sesi√≥n
                navigationSession = null;

                // Cerrar modal y redirigir
                const modal = bootstrap.Modal.getInstance(document.getElementById('completeModal'));
                modal.hide();

                setTimeout(() => {
                    window.location.href = '/driver/dashboard';
                }, 3000);
            } else {
                showNotification(data.error || 'Error completando ruta', 'error');
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }

        } catch (error) {
            showNotification('Error de conexi√≥n al completar ruta', 'error');
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        }
    }

    // Mostrar resumen de an√°lisis
    function showCompletionSummary(analysis) {
        const summaryHtml = `
            <div class="alert alert-success mb-3">
                <h6 class="mb-2">üìä An√°lisis del Recorrido Completado</h6>
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Distancia:</strong> ${analysis.actual_distance.toFixed(2)} km</p>
                        <p class="mb-1"><strong>Tiempo total:</strong> ${Math.round(analysis.total_time)} min</p>
                        <p class="mb-1"><strong>Velocidad prom.:</strong> ${analysis.avg_speed.toFixed(1)} km/h</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Paradas:</strong> ${analysis.stops_count}</p>
                        <p class="mb-1"><strong>Eficiencia:</strong> ${analysis.route_efficiency.toFixed(1)}%</p>
                        <p class="mb-1"><strong>Puntuaci√≥n:</strong> ${analysis.smooth_driving_score}/100</p>
                    </div>
                </div>
            </div>
        `;

        // Mostrar en el modal
        const container = document.getElementById('analysisContainer');
        document.getElementById('analysisContent').innerHTML = summaryHtml;
        container.style.display = 'block';
    }

    function pauseNavigation() {
        if (gpsActive) {
            stopGPS();
            showNotification('Navegaci√≥n pausada', 'warning');
        } else {
            showNotification('La navegaci√≥n ya est√° pausada', 'info');
        }
    }

    function cancelRoute() {
        if (confirm('¬øEst√°s seguro de que quieres cancelar la ruta?')) {
            if (gpsActive) stopGPS();

            // Limpiar sesi√≥n
            navigationSession = null;

            showNotification('Ruta cancelada', 'error');

            setTimeout(() => {
                window.location.href = '/driver/dashboard';
            }, 2000);
        }
    }

    // Sistema de notificaciones mejorado
    function showNotification(message, type = 'info') {
        const toast = document.getElementById('notificationToast');
        const messageEl = document.getElementById('toastMessage');
        const iconEl = document.getElementById('toastIcon');

        // Limpiar clases anteriores
        toast.className = 'notification-toast';

        // Configurar icono seg√∫n tipo
        let iconClass = 'fas fa-info-circle';
        switch (type) {
            case 'success':
                iconClass = 'fas fa-check-circle';
                break;
            case 'error':
            case 'danger':
                iconClass = 'fas fa-exclamation-triangle';
                break;
            case 'warning':
                iconClass = 'fas fa-exclamation-triangle';
                break;
        }

        // Agregar clase de tipo y configurar contenido
        toast.classList.add(type);
        iconEl.className = iconClass + ' me-2';
        messageEl.textContent = message;

        // Mostrar notificaci√≥n
        toast.classList.add('show');

        // Ocultar despu√©s de tiempo variable seg√∫n tipo
        const delay = type === 'error' ? 5000 : type === 'success' ? 4000 : 3000;
        setTimeout(() => {
            toast.classList.remove('show');
        }, delay);

        // Log para desarrollo
        console.log(`üîî ${type.toUpperCase()}: ${message}`);
    }

    // Configurar event listeners
    function setupEventListeners() {
        // Eventos de click con feedback h√°ptico
        document.querySelectorAll('.btn, .fab, .map-control-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                hapticFeedback();
                animateElement(this, 'bounce-in');
            });
        });

        // Manejo de orientaci√≥n de pantalla
        window.addEventListener('orientationchange', function () {
            setTimeout(() => {
                if (map) {
                    map.invalidateSize();
                }
            }, 500);
        });

        // Prevenir zoom accidental en inputs m√≥viles
        document.addEventListener('touchstart', function (e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        });

        // Limpiar recursos al salir
        window.addEventListener('beforeunload', function () {
            if (gpsActive) {
                stopGPS();
            }
        });

        console.log('‚úÖ Event listeners configurados');
    }

    // Funciones de utilidades adicionales
    function requestNotificationPermission() {
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    }

    function checkNetworkStatus() {
        const indicator = document.getElementById('connectionIndicator');
        const statusEl = document.getElementById('connectivityStatus');

        function updateStatus() {
            if (!navigator.onLine) {
                indicator.style.display = 'block';
                statusEl.innerHTML = `
                    <div class="d-flex align-items-center text-danger">
                        <i class="fas fa-wifi-slash me-2"></i>
                        <small>Sin conexi√≥n</small>
                    </div>
                `;
            } else {
                indicator.style.display = 'none';
                statusEl.innerHTML = `
                    <div class="d-flex align-items-center text-success">
                        <i class="fas fa-wifi me-2"></i>
                        <small>Conexi√≥n estable</small>
                    </div>
                `;
            }
        }

        window.addEventListener('online', updateStatus);
        window.addEventListener('offline', updateStatus);
        updateStatus();
    }

    // Monitoreo de bater√≠a
    async function monitorBattery() {
        if ('getBattery' in navigator) {
            try {
                const battery = await navigator.getBattery();
                batteryLevel = Math.round(battery.level * 100);

                battery.addEventListener('levelchange', () => {
                    batteryLevel = Math.round(battery.level * 100);

                    if (batteryLevel < 15) {
                        showNotification('Bater√≠a baja: optimizando GPS autom√°ticamente', 'warning');
                    }
                });

                console.log(`üîã Monitoreo de bater√≠a activado: ${batteryLevel}%`);
            } catch (error) {
                console.warn('‚ö†Ô∏è No se pudo acceder a informaci√≥n de bater√≠a');
            }
        }
    }

    // Feedback h√°ptico
    function hapticFeedback() {
        if ('vibrate' in navigator) {
            navigator.vibrate(50);
        }
    }

    // Animaciones
    function animateElement(element, animationClass) {
        element.classList.add(animationClass);
        setTimeout(() => {
            element.classList.remove(animationClass);
        }, 600);
    }

    // Gesti√≥n de tema
    function updateTheme() {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (prefersDark) {
            document.body.classList.add('dark-theme');
        }
    }

    // Overlays de carga
    function showLoadingOverlay() {
        document.getElementById('loadingOverlay').style.display = 'flex';
    }

    function hideLoadingOverlay() {
        const overlay = document.getElementById('loadingOverlay');
        overlay.classList.add('hidden');
        setTimeout(() => {
            overlay.style.display = 'none';
        }, 300);
    }

    // Inicializar tema y configuraciones finales
    updateTheme();
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateTheme);

    // Log de debug para desarrollo
    function debugLog(message, data = null) {
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            console.log(`[Navigation Debug] ${message}`, data);
        }
    }

    // Log inicial del sistema
    console.log('=== SISTEMA DE NAVEGACI√ìN INTELIGENTE ===');
    console.log('Caracter√≠sticas:', {
        gpsSupported: 'geolocation' in navigator,
        notificationSupported: 'Notification' in window,
        batterySupported: 'getBattery' in navigator,
        online: navigator.onLine,
        screenSize: `${window.screen.width}x${window.screen.height}`,
        viewportSize: `${window.innerWidth}x${window.innerHeight}`,
        isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
    });
    console.log('Ruta ID:', {{ route.id }});
    console.log('Completion ID:', {{ completion.id }});
    console.log('Veh√≠culo:', '{{ completion.vehicle.brand }} {{ completion.vehicle.model }}');
    console.log('Combustible inicial:', {{ completion.fuel_start }});
    console.log('===============================================');
</script>
{% endblock %}
